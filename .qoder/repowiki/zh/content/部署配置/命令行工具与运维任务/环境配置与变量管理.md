# 环境配置与变量管理

<cite>
**本文档中引用的文件**  
- [env_var_dox.clj](file://src/metabase/cmd/env_var_dox.clj)
- [config_file_gen.clj](file://src/metabase/cmd/config_file_gen.clj)
- [setting.clj](file://src/metabase/settings/models/setting.clj)
- [core.clj](file://src/metabase/settings/core.clj)
- [config-from_file.clj](file://src/metabase/core/config_from_file.clj)
- [env.clj](file://src/metabase/app_db/env.clj)
- [env-var-intro.md](file://src/metabase/cmd/resources/env-var-intro.md)
- [config-file-intro.md](file://src/metabase/cmd/resources/config-file-intro.md)
- [config-template.yaml](file://src/metabase/cmd/resources/config-template.yaml)
- [other-env-vars.md](file://src/metabase/cmd/resources/other-env-vars.md)
</cite>

## 目录
1. [环境变量配置机制](#环境变量配置机制)
2. [配置文件生成与合并逻辑](#配置文件生成与合并逻辑)
3. [配置优先级与加载流程](#配置优先级与加载流程)
4. [典型部署场景配置示例](#典型部署场景配置示例)
5. [配置验证与错误排查](#配置验证与错误排查)

## 环境变量配置机制

Metabase通过`env_var_dox.clj`文件中的文档生成机制，系统性地管理所有可通过环境变量配置的参数。环境变量名称遵循`MB_`前缀的命名约定，例如`MB_SITE_NAME`，其中设置名称被转换为大写并用下划线替换连字符。

每个环境变量的配置信息包括其名称、默认值、有效范围和配置优先级。核心配置机制通过`defsetting`宏定义，该宏不仅创建了设置的getter/setter函数，还自动将其与相应的环境变量关联。例如，一个名为`mandrill-api-key`的设置会自动关联到`MB_MANDRILL_API_KEY`环境变量。

环境变量的值通过`env-var-value`函数从系统环境中获取，该函数会将设置名称转换为环境变量格式。对于敏感设置，系统会进行特殊处理以防止信息泄露。某些设置具有特定的可见性（visibility）属性，如`:admin`或`:internal`，这决定了它们是否可以通过环境变量配置。

**Section sources**
- [env_var_dox.clj](file://src/metabase/cmd/env_var_dox.clj#L1-L228)
- [setting.clj](file://src/metabase/settings/models/setting.clj#L1205-L1234)
- [core.clj](file://src/metabase/settings/core.clj#L0-L27)

## 配置文件生成与合并逻辑

YAML配置模板的生成由`config_file_gen.clj`文件中的逻辑控制。该过程首先通过`get-settings`函数获取所有有效的配置设置，然后过滤掉不应用于配置文件的设置（如已弃用的设置）。

配置文件生成的核心流程如下：
1. 从`defsetting`定义中提取所有设置及其默认值
2. 创建一个排序的设置映射，确保配置文件的有序性
3. 将这些设置注入到基础YAML模板中
4. 生成最终的Markdown文档，其中包含可嵌入的YAML配置示例

配置文件与环境变量的合并逻辑遵循特定的优先级规则。当同时存在配置文件和环境变量时，环境变量的值具有最高优先级，会覆盖配置文件中的相应设置。这种合并机制允许用户在不同部署环境中灵活地覆盖默认配置。

基础YAML模板（`config-template.yaml`）提供了`users`、`databases`和`settings`等部分的示例结构，用户可以根据需要更新或移除这些部分。模板还支持使用`{{ env YOUR_ENV_VAR }}`语法来引用环境变量，实现了配置的动态化。

**Section sources**
- [config_file_gen.clj](file://src/metabase/cmd/config_file_gen.clj#L0-L101)
- [config-template.yaml](file://src/metabase/cmd/resources/config-template.yaml#L0-L42)
- [config-file-intro.md](file://src/metabase/cmd/resources/config-file-intro.md#L0-L26)

## 配置优先级与加载流程

Metabase的配置系统遵循明确的优先级层次，确保配置的一致性和可预测性。配置优先级从高到低依次为：环境变量 > 配置文件 > 默认值。

配置加载流程始于系统启动时，`bootstrap.clj`作为主入口点，调用核心初始化逻辑。在此过程中，系统首先检查环境变量，然后加载配置文件，最后应用默认值。对于应用数据库的连接配置，`env.clj`文件中的逻辑会根据`MB_DB_TYPE`环境变量的值（如`h2`、`postgres`、`mysql`）来确定连接方式。

某些配置项具有特殊的处理逻辑。例如，`MB_DB_CONNECTION_URI`环境变量可以替代多个`MB_DB_*`变量，提供更灵活的数据库连接配置。对于需要特殊处理的默认值（如`saml-attribute-email`），系统会在加载时将其重置为`nil`，以避免验证错误。

配置的可见性和作用域也影响其加载行为。具有`:internal`可见性的设置不会出现在配置文件中，而仅限用户或数据库本地的设置（`:user-local`或`:database-local`为`:only`）不能通过环境变量配置。这种设计确保了关键系统设置的安全性和一致性。

**Section sources**
- [env_var_dox.clj](file://src/metabase/cmd/env_var_dox.clj#L170-L205)
- [env.clj](file://src/metabase/app_db/env.clj#L80-L141)
- [bootstrap.clj](file://src/metabase/core/bootstrap.clj#L0-L36)

## 典型部署场景配置示例

### Docker容器化部署

在Docker环境中，环境变量通过`-e`参数直接传递给容器。以下是一个典型的Docker运行命令示例：

```bash
docker run -d -p 3000:3000 \
  -e MB_SITE_NAME="Awesome Company" \
  -e MB_DB_TYPE=postgres \
  -e MB_DB_HOST=db.example.com \
  -e MB_DB_PORT=5432 \
  -e MB_DB_USER=metabase \
  -e MB_DB_PASS=secret \
  -e MB_DB_DBNAME=metabase \
  --name metabase metabase/metabase
```

此配置将Metabase站点名称设置为"Awesome Company"，并连接到外部的PostgreSQL数据库。Docker部署的优势在于配置的清晰性和可重复性，所有设置都显式地定义在运行命令中。

### 云环境配置

在云环境中（如AWS、GCP或Azure），推荐使用云平台的密钥管理服务（如AWS KMS、GCP Secret Manager）来存储敏感配置，如数据库密码和加密密钥。通过环境变量引用这些密钥，可以实现安全的配置管理。

例如，在AWS ECS中，可以使用任务定义中的`secrets`字段来注入环境变量：

```json
"secrets": [
  {
    "name": "MB_DB_PASS",
    "valueFrom": "arn:aws:secretsmanager:region:account:secret:db-password"
  }
]
```

### 多实例集群设置

在多实例集群中，所有实例必须共享相同的应用数据库和缓存后端（如Redis）。关键配置包括：

- `MB_QP_CACHE_BACKEND=redis`：将查询缓存后端设置为Redis
- `MB_REDIS_URL=redis://redis-server:6379`：指定Redis服务器地址
- `MB_JETTY_HOST=0.0.0.0`：允许从任何网络接口访问
- `MB_DB_CONNECTION_URI`：使用连接字符串确保所有实例连接到同一数据库

这种配置确保了集群中所有实例的数据一致性和会话共享。

**Section sources**
- [env-var-intro.md](file://src/metabase/cmd/resources/env-var-intro.md#L0-L52)
- [other-env-vars.md](file://src/metabase/cmd/resources/other-env-vars.md#L0-L488)

## 配置验证与错误排查

Metabase内置了配置验证机制，用于检测配置格式错误。`validate-settings-formatting!`函数会在启动时检查所有已注册设置的格式，例如验证JSON字符串的有效性或数字格式的正确性。如果发现无效配置，系统会抛出异常并阻止启动，确保配置的完整性。

常见配置错误及排查方法包括：

1. **数据库连接失败**：检查`MB_DB_TYPE`、`MB_DB_HOST`、`MB_DB_PORT`等环境变量是否正确。使用`MB_DB_CONNECTION_URI`可以简化复杂的连接配置。
2. **环境变量未生效**：确认环境变量名称是否以`MB_`开头且格式正确。某些设置（如仅限本地的设置）不能通过环境变量配置。
3. **配置文件解析错误**：确保YAML语法正确，特别是缩进和引号的使用。敏感值（如密码）应使用引号包围。
4. **权限问题**：检查运行Metabase的用户是否有权访问配置文件和插件目录（由`MB_PLUGINS_DIR`指定）。

对于调试，可以启用`MB_NS_TRACE`环境变量来跟踪特定命名空间的日志，但需注意这可能会暴露敏感信息。配置验证失败时，系统日志会提供详细的错误信息，包括出错的设置名称和解析错误类型。

**Section sources**
- [setting.clj](file://src/metabase/settings/models/setting.clj#L1553-L1642)
- [env_var_dox.clj](file://src/metabase/cmd/env_var_dox.clj#L202-L227)