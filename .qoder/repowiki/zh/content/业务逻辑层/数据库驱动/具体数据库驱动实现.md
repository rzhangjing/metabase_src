# 具体数据库驱动实现

<cite>
**本文档引用的文件**   
- [sql_jdbc.clj](file://src/metabase/driver/sql_jdbc.clj)
- [h2.clj](file://src/metabase/driver/h2.clj)
- [mysql.clj](file://src/metabase/driver/mysql.clj)
- [postgres.clj](file://src/metabase/driver/postgres.clj)
- [mysql/ddl.clj](file://src/metabase/driver/mysql/ddl.clj)
- [postgres/ddl.clj](file://src/metabase/driver/postgres/ddl.clj)
- [sql/ddl.clj](file://src/metabase/driver/sql/ddl.clj)
- [sql/query_processor.clj](file://src/metabase/driver/sql/query_processor.clj)
</cite>

## 目录
1. [引言](#引言)
2. [通用SQL JDBC驱动](#通用sql-jdbc驱动)
3. [H2驱动实现](#h2驱动实现)
4. [MySQL驱动实现](#mysql驱动实现)
5. [PostgreSQL驱动实现](#postgresql驱动实现)
6. [驱动对比分析](#驱动对比分析)
7. [结论](#结论)

## 引言
本文档深入分析Metabase中H2、MySQL和PostgreSQL数据库驱动的具体实现。文档将探讨各驱动如何继承`SQLJDBC`通用类并重写特定方法以适配各自数据库的特性。重点分析`h2.clj`、`mysql.clj`和`postgres.clj`文件中的DDL处理、类型映射和性能优化策略，以及各数据库方言在SQL生成上的差异、已知限制和最佳实践。

## 通用SQL JDBC驱动
`SQLJDBC`驱动作为所有基于JDBC的SQL数据库驱动的抽象基类，提供了大量通用实现。它定义了数据库连接、查询执行、元数据同步和DDL操作的基本框架。

该驱动通过Clojure的多方法（multimethod）机制，为所有子类提供了默认的实现。例如，`query`方法用于执行HoneySQL形式的查询，`can-connect?`方法用于检查数据库连接，以及`execute-reducible-query`方法用于执行可还原的查询。

**Section sources**
- [sql_jdbc.clj](file://src/metabase/driver/sql_jdbc.clj#L1-L333)

## H2驱动实现
H2驱动继承自`SQLJDBC`驱动，并针对H2数据库的特性进行了大量重写和优化。

### 特殊方法重写
H2驱动重写了`current-db-time`、`quote-style`和`column->special-type`等方法。例如，`db-default-timezone`方法返回JVM的时区，因为H2数据库使用JVM的时区设置。

```clojure
(defmethod driver/db-default-timezone :h2
  [_driver _database]
  (System/getProperty "user.timezone"))
```

### DDL处理
H2驱动在`h2.clj`文件中实现了自己的DDL处理逻辑。它重写了`add-columns!`和`alter-table-columns!`方法，以支持H2数据库的特定语法。

```clojure
(defmethod driver/add-columns! :h2
  [driver db-id table-name column-definitions & {:as settings}]
  (let [f (get-method driver/add-columns! :sql-jdbc)]
    (doseq [[k v] column-definitions]
      (f driver db-id table-name {k v} settings))))
```

### 类型映射
H2驱动定义了详细的类型映射规则，将数据库类型映射到Metabase的基类型。它使用BNF语法来定义所有可能的数据类型，并通过`expand-grammar`函数展开。

```clojure
(def ^:private base-type->db-type-grammar
  '{:type/Boolean             #{BOOLEAN}
    :type/Integer             #{TINYINT SMALLINT INTEGER INT}
    :type/BigInteger          #{BIGINT}
    :type/Decimal             #{NUMERIC DECIMAL DEC}
    :type/Float               #{REAL FLOAT "DOUBLE PRECISION" DECFLOAT}
    :type/Text                #{CHARACTER CHAR (NATIONAL #{CHARACTER CHAR}) NCHAR ...}
    :type/UUID                #{UUID}
    :type/*                   #{ARRAY BINARY "BINARY VARYING" VARBINARY ...}
    :type/Date                #{DATE}
    :type/DateTime            #{TIMESTAMP}
    :type/Time                #{TIME "TIME WITHOUT TIME ZONE"}
    :type/TimeWithLocalTZ     #{"TIME WITH TIME ZONE"}
    :type/DateTimeWithLocalTZ #{"TIMESTAMP WITH TIME ZONE"}})
```

**Section sources**
- [h2.clj](file://src/metabase/driver/h2.clj#L1-L676)

## MySQL驱动实现
MySQL驱动同样继承自`SQLJDBC`驱动，并针对MySQL数据库的特性进行了定制。

### 特殊方法重写
MySQL驱动重写了`current-db-time`、`quote-style`和`column->special-type`等方法。例如，`quote-style`方法返回`:mysql`，以使用MySQL特定的引号风格。

```clojure
(defmethod sql.qp/quote-style :mysql [_] :mysql)
```

### DDL处理
MySQL驱动在`mysql/ddl.clj`文件中实现了自己的DDL处理逻辑。它重写了`refresh!`和`unpersist!`方法，以支持MySQL数据库的特定语法。

```clojure
(defmethod ddl.i/refresh! :mysql
  [driver database definition dataset-query]
  (let [{:keys [query params]} (driver-api/compile dataset-query)
        db-spec (sql-jdbc.conn/db->pooled-connection-spec database)]
    (sql-jdbc.execute/do-with-connection-with-options
     driver
     database
     {:write? true}
     (fn [conn]
       (sql.ddl/execute! conn [(sql.ddl/drop-table-sql database (:table-name definition))])
       (execute-with-timeout! driver
                              conn
                              db-spec
                              (.toMillis (t/minutes 10))
                              (into [(sql.ddl/create-table-sql database definition query)] params))
       {:state :success}))))
```

### 类型映射
MySQL驱动定义了详细的类型映射规则，将数据库类型映射到Metabase的基类型。它使用一个映射表来定义所有可能的数据类型。

```clojure
(defmethod sql-jdbc.sync/database-type->base-type :mysql
  [_ database-type]
  ({:BIGINT     :type/BigInteger
    :BINARY     :type/*
    :BIT        :type/Boolean
    :BLOB       :type/*
    :CHAR       :type/Text
    :DATE       :type/Date
    :DATETIME   :type/DateTime
    :DECIMAL    :type/Decimal
    :DOUBLE     :type/Float
    :ENUM       :type/MySQLEnum
    :FLOAT      :type/Float
    :INT        :type/Integer
    :INTEGER    :type/Integer
    :LONGBLOB   :type/*
    :LONGTEXT   :type/Text
    :MEDIUMBLOB :type/*
    :MEDIUMINT  :type/Integer
    :MEDIUMTEXT :type/Text
    :NUMERIC    :type/Decimal
    :REAL       :type/Float
    :SET        :type/*
    :SMALLINT   :type/Integer
    :TEXT       :type/Text
    :TIME       :type/Time
    :TIMESTAMP  :type/DateTimeWithLocalTZ ; stored as UTC in the database
    :TINYBLOB   :type/*
    :TINYINT    :type/Integer
    :TINYTEXT   :type/Text
    :VARBINARY  :type/*
    :VARCHAR    :type/Text
    :YEAR       :type/Integer
    :JSON       :type/JSON}
   ;; strip off " UNSIGNED" from end if present
   (keyword (str/replace (name database-type) #"\sUNSIGNED$" ""))))
```

**Section sources**
- [mysql.clj](file://src/metabase/driver/mysql.clj#L1-L1164)
- [mysql/ddl.clj](file://src/metabase/driver/mysql/ddl.clj#L1-L180)

## PostgreSQL驱动实现
PostgreSQL驱动继承自`SQLJDBC`驱动，并针对PostgreSQL数据库的特性进行了大量重写和优化。

### 特殊方法重写
PostgreSQL驱动重写了`current-db-time`、`quote-style`和`column->special-type`等方法。例如，`db-default-timezone`方法通过执行SQL查询来获取数据库的时区设置。

```clojure
(defmethod driver/db-default-timezone :postgres
  [driver database]
  (sql-jdbc.execute/do-with-connection-with-options
   driver database nil
   (fn [^java.sql.Connection conn]
     (with-open [stmt (.prepareStatement conn "show timezone;")
                 rset (.executeQuery stmt)]
       (when (.next rset)
         (.getString rset 1))))))
```

### DDL处理
PostgreSQL驱动在`postgres/ddl.clj`文件中实现了自己的DDL处理逻辑。它重写了`refresh!`和`unpersist!`方法，以支持PostgreSQL数据库的特定语法。

```clojure
(defmethod ddl.i/refresh! :postgres
  [driver database definition dataset-query]
  (let [{:keys [query params]} (driver-api/compile dataset-query)]
    (sql-jdbc.execute/do-with-connection-with-options
     driver
     database
     {:write? true}
     (fn [^java.sql.Connection conn]
       (jdbc/with-db-transaction [tx {:connection conn}]
         (set-statement-timeout! tx)
         (sql.ddl/execute! tx [(sql.ddl/drop-table-sql database (:table-name definition))])
         (sql.ddl/execute! tx (into [(sql.ddl/create-table-sql database definition query)] params)))
       {:state :success}))))
```

### 类型映射
PostgreSQL驱动定义了详细的类型映射规则，将数据库类型映射到Metabase的基类型。它使用一个映射表来定义所有可能的数据类型，并特别处理了枚举类型。

```clojure
(defmethod sql-jdbc.sync/database-type->base-type :postgres
  [_ database-type]
  ({:BIGINT     :type/BigInteger
    :BINARY     :type/*
    :BIT        :type/Boolean
    :BLOB       :type/*
    :CHAR       :type/Text
    :DATE       :type/Date
    :DATETIME   :type/DateTime
    :DECIMAL    :type/Decimal
    :DOUBLE     :type/Float
    :ENUM       :type/MySQLEnum
    :FLOAT      :type/Float
    :INT        :type/Integer
    :INTEGER    :type/Integer
    :LONGBLOB   :type/*
    :LONGTEXT   :type/Text
    :MEDIUMBLOB :type/*
    :MEDIUMINT  :type/Integer
    :MEDIUMTEXT :type/Text
    :NUMERIC    :type/Decimal
    :REAL       :type/Float
    :SET        :type/*
    :SMALLINT   :type/Integer
    :TEXT       :type/Text
    :TIME       :type/Time
    :TIMESTAMP  :type/DateTimeWithLocalTZ ; stored as UTC in the database
    :TINYBLOB   :type/*
    :TINYINT    :type/Integer
    :TINYTEXT   :type/Text
    :VARBINARY  :type/*
    :VARCHAR    :type/Text
    :YEAR       :type/Integer
    :JSON       :type/JSON}
   ;; strip off " UNSIGNED" from end if present
   (keyword (str/replace (name database-type) #"\sUNSIGNED$" ""))))
```

**Section sources**
- [postgres.clj](file://src/metabase/driver/postgres.clj#L1-L1293)
- [postgres/ddl.clj](file://src/metabase/driver/postgres/ddl.clj#L1-L124)

## 驱动对比分析
通过对H2、MySQL和PostgreSQL驱动的分析，我们可以看到它们在继承`SQLJDBC`通用类的基础上，各自重写了特定方法以适配数据库特性。

### SQL生成差异
- **H2**: 使用`timestampadd`函数来添加时间间隔。
- **MySQL**: 使用`date_trunc`函数来截断日期。
- **PostgreSQL**: 使用`date_trunc`函数来截断日期。

### 已知限制
- **H2**: 不支持设置时区。
- **MySQL**: 不支持在同一个查询中同时使用`lag/lead`和`GROUP BY`。
- **PostgreSQL**: 不支持在同一个查询中同时使用`lag/lead`和`GROUP BY`。

### 最佳实践
- **H2**: 在连接字符串中添加`IFEXISTS=TRUE`以防止意外创建数据库。
- **MySQL**: 在连接字符串中添加`useSSL=true`以启用SSL连接。
- **PostgreSQL**: 在连接字符串中添加`sslmode=require`以启用SSL连接。

**Section sources**
- [sql_jdbc.clj](file://src/metabase/driver/sql_jdbc.clj#L1-L333)
- [h2.clj](file://src/metabase/driver/h2.clj#L1-L676)
- [mysql.clj](file://src/metabase/driver/mysql.clj#L1-L1164)
- [postgres.clj](file://src/metabase/driver/postgres.clj#L1-L1293)

## 结论
本文档详细分析了Metabase中H2、MySQL和PostgreSQL数据库驱动的具体实现。通过对比分析，我们可以看到各驱动在继承`SQLJDBC`通用类的基础上，各自重写了特定方法以适配数据库特性。这些实现包括DDL处理、类型映射和性能优化策略，以及各数据库方言在SQL生成上的差异、已知限制和最佳实践。