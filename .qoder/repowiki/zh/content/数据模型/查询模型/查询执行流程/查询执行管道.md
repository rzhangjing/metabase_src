# 查询执行管道

<cite>
**本文档中引用的文件**  
- [query_processor.clj](file://src/metabase/query_processor.clj)
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj)
- [preprocess.clj](file://src/metabase/query_processor/preprocess.clj)
- [execute.clj](file://src/metabase/query_processor/execute.clj)
- [reducible.clj](file://src/metabase/query_processor/reducible.clj)
- [setup.clj](file://src/metabase/query_processor/setup.clj)
- [compile.clj](file://src/metabase/query_processor/compile.clj)
- [parameters.clj](file://src/metabase/query_processor/middleware/parameters.clj)
- [resolve_source_table.clj](file://src/metabase/query_processor/middleware/resolve_source_table.clj)
- [resolve_fields.clj](file://src/metabase/query_processor/middleware/resolve_fields.clj)
- [add_implicit_clauses.clj](file://src/metabase/query_processor/middleware/add_implicit_clauses.clj)
- [app_db\query_cancelation.clj](file://src/metabase/app_db/query_cancelation.clj)
- [schema.clj](file://src/metabase/query_processor/schema.clj)
</cite>

## 目录
1. [简介](#简介)
2. [查询执行管道概览](#查询执行管道概览)
3. [预处理阶段](#预处理阶段)
4. [执行阶段](#执行阶段)
5. [结果处理与流式传输](#结果处理与流式传输)
6. [查询取消机制](#查询取消机制)
7. [动态变量协调](#动态变量协调)
8. [数据结构转换示例](#数据结构转换示例)

## 简介
Metabase的查询执行管道是一个复杂的处理流程，负责将用户提交的MBQL查询转换为数据库可执行的原生查询，并返回结果。该管道从`process-query`入口开始，通过一系列中间件链对查询进行预处理、编译、执行和后处理。本文档详细描述了这一完整流程，重点分析了预处理阶段的查询预处理顺序、执行阶段的数据库驱动执行机制、结果流的reducible处理方式、查询取消的支持机制以及通过动态变量协调执行流程的方法。

## 查询执行管道概览

```mermaid
graph TD
A[process-query入口] --> B[setup中间件]
B --> C[预处理阶段]
C --> D[编译阶段]
D --> E[执行阶段]
E --> F[结果处理]
F --> G[返回结果]
subgraph "预处理阶段"
C1[参数替换]
C2[源表解析]
C3[字段解析]
C4[隐式子句添加]
end
subgraph "执行阶段"
E1[驱动执行]
E2[结果流处理]
end
C --> C1
C --> C2
C --> C3
C --> C4
E --> E1
E --> E2
```

**Diagram sources**
- [query_processor.clj](file://src/metabase/query_processor.clj#L24-L52)
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L49-L82)

**Section sources**
- [query_processor.clj](file://src/metabase/query_processor.clj#L24-L82)
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L49-L82)

## 预处理阶段

预处理阶段是查询执行管道的关键环节，它通过一系列中间件对查询进行转换和优化。这些中间件按照特定顺序执行，确保查询在编译前处于正确的状态。

```mermaid
flowchart TD
Start([预处理开始]) --> Normalize["标准化查询"]
Normalize --> Permissions["移除权限键"]
Permissions --> Validate["验证查询"]
Validate --> SourceTable["解析源表"]
SourceTable --> Fields["解析字段"]
Fields --> Implicit["添加隐式子句"]
Implicit --> Binning["更新分箱策略"]
Binning --> Desugar["去糖化"]
Desugar --> DefaultUnit["添加默认时间单位"]
DefaultUnit --> Joins["添加隐式连接"]
Joins --> FixRefs["修复错误字段引用"]
FixRefs --> RemoveInactive["移除非活动字段引用"]
RemoveInactive --> Constraints["添加默认约束"]
Constraints --> Limit["添加默认限制"]
Limit --> End([预处理完成])
```

**Diagram sources**
- [preprocess.clj](file://src/metabase/query_processor/preprocess.clj#L121-L143)
- [middleware/parameters.clj](file://src/metabase/query_processor/middleware/parameters.clj#L100-L120)
- [middleware/resolve_source_table.clj](file://src/metabase/query_processor/middleware/resolve_source_table.clj#L10-L13)
- [middleware/resolve_fields.clj](file://src/metabase/query_processor/middleware/resolve_fields.clj#L30-L37)
- [middleware/add_implicit_clauses.clj](file://src/metabase/query_processor/middleware/add_implicit_clauses.clj#L80-L93)

**Section sources**
- [preprocess.clj](file://src/metabase/query_processor/preprocess.clj#L121-L143)
- [middleware/parameters.clj](file://src/metabase/query_processor/middleware/parameters.clj#L100-L120)
- [middleware/resolve_source_table.clj](file://src/metabase/query_processor/middleware/resolve_source_table.clj#L10-L13)
- [middleware/resolve_fields.clj](file://src/metabase/query_processor/middleware/resolve_fields.clj#L30-L37)
- [middleware/add_implicit_clauses.clj](file://src/metabase/query_processor/middleware/add_implicit_clauses.clj#L80-L93)

### 参数替换
参数替换中间件负责将查询中的参数占位符替换为实际值。它处理两种类型的参数：MBQL查询中的参数和原生查询中的模板标签。

**Section sources**
- [middleware/parameters.clj](file://src/metabase/query_processor/middleware/parameters.clj#L100-L120)

### 源表解析
源表解析中间件负责解析查询中引用的源表，将其从表ID转换为完整的表元数据对象，并存储在查询处理器的元数据提供者中。

**Section sources**
- [middleware/resolve_source_table.clj](file://src/metabase/query_processor/middleware/resolve_source_table.clj#L10-L13)

### 字段解析
字段解析中间件负责解析查询中引用的所有字段，包括直接引用的字段和通过表达式间接引用的字段。它确保所有引用的字段都存在于元数据提供者中。

**Section sources**
- [middleware/resolve_fields.clj](file://src/metabase/query_processor/middleware/resolve_fields.clj#L30-L37)

### 隐式子句添加
隐式子句添加中间件负责为查询添加必要的隐式子句，如字段列表和排序子句。当查询没有明确指定字段且没有聚合或分组时，它会自动添加所有可用字段。

**Section sources**
- [middleware/add_implicit_clauses.clj](file://src/metabase/query_processor/middleware/add_implicit_clauses.clj#L80-L93)

## 执行阶段

执行阶段负责将编译后的查询交给数据库驱动执行，并处理返回的结果流。这个阶段通过`*execute*`动态变量协调执行流程。

```mermaid
sequenceDiagram
participant QueryProcessor as 查询处理器
participant Execute as *execute*
participant Driver as 数据库驱动
participant Reduce as *reduce*
QueryProcessor->>Execute : 调用*execute* (query, respond)
Execute->>Driver : 调用驱动执行查询
Driver->>Execute : 返回结果元数据和可约化行
Execute->>Reduce : 调用respond(metadata, reducible-rows)
Reduce->>Reduce : 转换可约化行为结果
Reduce->>QueryProcessor : 调用*result*(result)
QueryProcessor->>QueryProcessor : 返回最终结果
```

**Diagram sources**
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L49-L82)
- [execute.clj](file://src/metabase/query_processor/execute.clj#L70-L99)

**Section sources**
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L49-L82)
- [execute.clj](file://src/metabase/query_processor/execute.clj#L70-L99)

## 结果处理与流式传输

结果处理阶段使用reducible机制处理查询结果流，允许在不将所有结果加载到内存的情况下进行处理。

```mermaid
flowchart TD
A[可约化行] --> B{是否已约化?}
B --> |是| C[返回结果]
B --> |否| D{是否已取消?}
D --> |是| E[返回]
D --> |否| F{是否有下一行?}
F --> |否| G[所有行已消耗]
F --> |是| H[应用约化函数]
H --> B
```

**Diagram sources**
- [reducible.clj](file://src/metabase/query_processor/reducible.clj#L50-L80)
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L49-L82)

**Section sources**
- [reducible.clj](file://src/metabase/query_processor/reducible.clj#L50-L80)
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L49-L82)

## 查询取消机制

查询取消机制通过`*canceled-chan*`通道支持查询取消功能。当HTTP连接关闭时，系统会向该通道发送消息，通知查询执行可以安全终止。

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Executing : 开始执行
Executing --> Canceled : 收到取消消息
Executing --> Completed : 执行完成
Canceled --> [*]
Completed --> [*]
```

**Diagram sources**
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L10-L25)
- [app_db\query_cancelation.clj](file://src/metabase/app_db/query_cancelation.clj#L10-L30)

**Section sources**
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L10-L25)
- [app_db\query_cancelation.clj](file://src/metabase/app_db/query_cancelation.clj#L10-L30)

## 动态变量协调

查询执行管道使用多个动态变量来协调执行流程，包括`*run*`、`*execute*`、`*reduce*`和`*result*`。

```mermaid
classDiagram
class QueryProcessor {
+process-query(query, rff)
+userland-query(query, info)
}
class Pipeline {
+*canceled-chan*
+*run*(query, rff)
+*execute*(driver, query, respond)
+*reduce*(rff, metadata, reducible-rows)
+*result*(result)
}
QueryProcessor --> Pipeline : 使用动态变量
```

**Diagram sources**
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L10-L82)
- [query_processor.clj](file://src/metabase/query_processor.clj#L24-L52)

**Section sources**
- [pipeline.clj](file://src/metabase/query_processor/pipeline.clj#L10-L82)
- [query_processor.clj](file://src/metabase/query_processor.clj#L24-L52)

## 数据结构转换示例

以下是查询在管道中各阶段的数据结构变换示例：

```mermaid
graph LR
A[原始查询] --> B[预处理后查询]
B --> C[编译后查询]
C --> D[执行结果]
subgraph "数据结构"
A1["{:database 1, :type :query, :query {:source-table 2}}"]
B1["{:database 1, :type :query, :query {:source-table {:id 2, ...}, :fields [...], :order-by [...]}}"]
C1["{:native {:query \"SELECT * FROM table WHERE id = ?\", :params [1]}}"]
D1["{:data {:cols [...], :rows [...]}, :row_count 100, :status :completed}"]
end
A --> A1
B --> B1
C --> C1
D --> D1
```

**Diagram sources**
- [preprocess.clj](file://src/metabase/query_processor/preprocess.clj#L121-L143)
- [compile.clj](file://src/metabase/query_processor/compile.clj#L80-L96)
- [reducible.clj](file://src/metabase/query_processor/reducible.clj#L10-L30)
- [schema.clj](file://src/metabase/query_processor/schema.clj#L50-L80)

**Section sources**
- [preprocess.clj](file://src/metabase/query_processor/preprocess.clj#L121-L143)
- [compile.clj](file://src/metabase/query_processor/compile.clj#L80-L96)
- [reducible.clj](file://src/metabase/query_processor/reducible.clj#L10-L30)
- [schema.clj](file://src/metabase/query_processor/schema.clj#L50-L80)