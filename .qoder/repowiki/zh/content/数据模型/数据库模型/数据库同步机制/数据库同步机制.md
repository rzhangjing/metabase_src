# æ•°æ®åº“åŒæ­¥æœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj)
- [sync_metadata.clj](file://src/metabase/sync/sync_metadata.clj)
- [fetch_metadata.clj](file://src/metabase/sync/fetch_metadata.clj)
- [util.clj](file://src/metabase/sync/util.clj)
- [schedules.clj](file://src/metabase/sync/schedules.clj)
- [field_values.clj](file://src/metabase/sync/field_values.clj)
- [notify.clj](file://src/metabase/sync/api/notify.clj)
- [interface.clj](file://src/metabase/sync/interface.clj)
- [driver.clj](file://src/metabase/driver.clj)
- [describe_table.clj](file://src/metabase/driver/sql_jdbc/sync/describe_table.clj)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [å®šæ—¶ä»»åŠ¡è°ƒåº¦æœºåˆ¶](#å®šæ—¶ä»»åŠ¡è°ƒåº¦æœºåˆ¶)
4. [å…ƒæ•°æ®åŒæ­¥æµç¨‹](#å…ƒæ•°æ®åŒæ­¥æµç¨‹)
5. [é©±åŠ¨ç¨‹åºæ¥å£](#é©±åŠ¨ç¨‹åºæ¥å£)
6. [åŒæ­¥ç±»å‹ä¸åˆ¤æ–­é€»è¾‘](#åŒæ­¥ç±»å‹ä¸åˆ¤æ–­é€»è¾‘)
7. [é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥](#é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥)
8. [UIçŠ¶æ€å±•ç¤º](#uiçŠ¶æ€å±•ç¤º)
9. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## æ¦‚è¿°

Metabaseçš„æ•°æ®åº“åŒæ­¥æœºåˆ¶æ˜¯ä¸€ä¸ªå¤æ‚è€Œç²¾å¯†çš„ç³»ç»Ÿï¼Œè´Ÿè´£ç»´æŠ¤Metabaseå®ä¾‹ä¸å¤–éƒ¨æ•°æ®åº“ä¹‹é—´çš„å…ƒæ•°æ®ä¸€è‡´æ€§ã€‚è¯¥ç³»ç»Ÿé€šè¿‡å®šæ—¶ä»»åŠ¡å’Œæ‰‹åŠ¨è§¦å‘ä¸¤ç§æ–¹å¼å®ç°æ•°æ®åº“å…ƒæ•°æ®çš„åŒæ­¥ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€å­—æ®µå®šä¹‰ã€ä¸»é”®ã€å¤–é”®ã€ç´¢å¼•ç­‰ä¿¡æ¯çš„å®æ—¶æ›´æ–°ã€‚

æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š
- **å®šæ—¶åŒæ­¥**ï¼šåŸºäºQuartzè°ƒåº¦å™¨çš„å®šæœŸå…ƒæ•°æ®åŒæ­¥
- **æ‰‹åŠ¨åŒæ­¥**ï¼šç”¨æˆ·ä¸»åŠ¨è§¦å‘çš„å³æ—¶åŒæ­¥æ“ä½œ  
- **å¢é‡åŒæ­¥**ï¼šä»…åŒæ­¥å‘ç”Ÿå˜åŒ–çš„å…ƒæ•°æ®éƒ¨åˆ†
- **å…¨é‡åŒæ­¥**ï¼šé‡æ–°åŒæ­¥æ•´ä¸ªæ•°æ®åº“çš„æ‰€æœ‰å…ƒæ•°æ®
- **å­—æ®µå€¼ç¼“å­˜**ï¼šç»´æŠ¤å­—æ®µå€¼çš„ç»Ÿè®¡ä¿¡æ¯å’Œå”¯ä¸€å€¼åˆ—è¡¨

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
subgraph "ç”¨æˆ·ç•Œé¢å±‚"
UI[Webç•Œé¢]
API[APIç«¯ç‚¹]
end
subgraph "ä»»åŠ¡è°ƒåº¦å±‚"
QS[Quartzè°ƒåº¦å™¨]
ST[åŒæ­¥ä»»åŠ¡ç®¡ç†å™¨]
end
subgraph "åŒæ­¥å¼•æ“å±‚"
SM[å…ƒæ•°æ®åŒæ­¥å™¨]
FMV[å­—æ®µå€¼ç¼“å­˜å™¨]
AE[åˆ†æå¼•æ“]
end
subgraph "é©±åŠ¨ç¨‹åºå±‚"
DR[æ•°æ®åº“é©±åŠ¨]
DM[å…ƒæ•°æ®æå–å™¨]
end
subgraph "å­˜å‚¨å±‚"
DB[(Metabaseæ•°æ®åº“)]
MD[(å¤–éƒ¨æ•°æ®åº“)]
end
UI --> API
API --> ST
ST --> QS
QS --> SM
QS --> FMV
SM --> AE
SM --> DR
DR --> DM
DM --> MD
SM --> DB
FMV --> DB
AE --> DB
```

**å›¾è¡¨æ¥æº**
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj#L1-L50)
- [sync_metadata.clj](file://src/metabase/sync/sync_metadata.clj#L1-L30)

## å®šæ—¶ä»»åŠ¡è°ƒåº¦æœºåˆ¶

### ä»»åŠ¡ç±»å‹ä¸é…ç½®

Metabaseå®šä¹‰äº†ä¸¤ç§ä¸»è¦çš„åŒæ­¥ä»»åŠ¡ï¼š

1. **åŒæ­¥ä¸åˆ†æä»»åŠ¡** (`SyncAndAnalyzeDatabase`)
   - åŒæ­¥æ•°æ®åº“å…ƒæ•°æ®
   - æ‰§è¡Œæ•°æ®åˆ†æå’ŒæŒ‡çº¹è¯†åˆ«
   - æ”¯æŒå¹¶å‘æ‰§è¡Œé™åˆ¶

2. **å­—æ®µå€¼ç¼“å­˜ä»»åŠ¡** (`UpdateFieldValues`)
   - æ›´æ–°å­—æ®µçš„ç»Ÿè®¡ä¿¡æ¯
   - ç»´æŠ¤å­—æ®µå€¼çš„å”¯ä¸€å€¼åˆ—è¡¨
   - æ”¯æŒå¯é€‰çš„å¢é‡æ›´æ–°

### è°ƒåº¦é…ç½®

```mermaid
flowchart TD
Start([æ•°æ®åº“æ·»åŠ ]) --> Check{æ£€æŸ¥è°ƒåº¦è®¾ç½®}
Check --> |ç”¨æˆ·æ§åˆ¶| UserSchedule[ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰è°ƒåº¦]
Check --> |ç³»ç»Ÿæ§åˆ¶| RandomSchedule[ç”Ÿæˆéšæœºè°ƒåº¦æ—¶é—´]
UserSchedule --> Validate{éªŒè¯è°ƒåº¦æ ¼å¼}
RandomSchedule --> Validate
Validate --> |æœ‰æ•ˆ| ScheduleTask[åˆ›å»ºQuartzä»»åŠ¡]
Validate --> |æ— æ•ˆ| DefaultSchedule[ä½¿ç”¨é»˜è®¤è°ƒåº¦]
DefaultSchedule --> ScheduleTask
ScheduleTask --> Monitor[ç›‘æ§ä»»åŠ¡æ‰§è¡Œ]
Monitor --> Complete([ä»»åŠ¡å°±ç»ª])
```

**å›¾è¡¨æ¥æº**
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj#L300-L367)
- [schedules.clj](file://src/metabase/sync/schedules.clj#L40-L74)

### æ‰§è¡Œå‘¨æœŸé…ç½®

ç³»ç»Ÿæä¾›äº†çµæ´»çš„è°ƒåº¦é…ç½®é€‰é¡¹ï¼š

| ä»»åŠ¡ç±»å‹ | é»˜è®¤è°ƒåº¦ | éšæœºåŒ–ç­–ç•¥ | æœ€å°é—´éš” |
|---------|---------|-----------|---------|
| å…ƒæ•°æ®åŒæ­¥ | æ¯å°æ—¶ä¸€æ¬¡ | é¿å¼€50åˆ†é’Ÿ | 1å°æ—¶ |
| å­—æ®µå€¼ç¼“å­˜ | æ¯å¤©ä¸€æ¬¡ | éšæœºå°æ—¶ | 1å¤© |

**èŠ‚æ¥æº**
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj#L300-L367)
- [schedules.clj](file://src/metabase/sync/schedules.clj#L40-L74)

## å…ƒæ•°æ®åŒæ­¥æµç¨‹

### åŒæ­¥æ­¥éª¤åˆ†è§£

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Task as ä»»åŠ¡è°ƒåº¦å™¨
participant SM as å…ƒæ•°æ®åŒæ­¥å™¨
participant Driver as æ•°æ®åº“é©±åŠ¨
participant DB as å¤–éƒ¨æ•°æ®åº“
participant Meta as å…ƒæ•°æ®å­˜å‚¨
User->>Task : è§¦å‘åŒæ­¥ä»»åŠ¡
Task->>SM : æ‰§è¡Œsync-db-metadata!
SM->>Driver : describe-database()
Driver->>DB : æŸ¥è¯¢ç³»ç»Ÿè¡¨
DB-->>Driver : è¿”å›å…ƒæ•°æ®
Driver-->>SM : æ ¼å¼åŒ–å…ƒæ•°æ®
SM->>SM : åŒæ­¥è¡¨ç»“æ„
SM->>SM : åŒæ­¥å­—æ®µå®šä¹‰
SM->>SM : åŒæ­¥å¤–é”®å…³ç³»
SM->>SM : åŒæ­¥ç´¢å¼•ä¿¡æ¯
SM->>Meta : æ›´æ–°Metabaseå­˜å‚¨
Meta-->>SM : ç¡®è®¤æ›´æ–°
SM-->>Task : è¿”å›åŒæ­¥ç»“æœ
Task-->>User : æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
```

**å›¾è¡¨æ¥æº**
- [sync_metadata.clj](file://src/metabase/sync/sync_metadata.clj#L40-L78)
- [fetch_metadata.clj](file://src/metabase/sync/fetch_metadata.clj#L25-L50)

### åŒæ­¥æ­¥éª¤è¯¦è§£

1. **æ•°æ®åº“ç‰ˆæœ¬æ£€æµ‹** (`sync-dbms-version`)
   - è·å–æ•°æ®åº“ç®¡ç†ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯
   - å­˜å‚¨åˆ°æ•°æ®åº“è®°å½•ä¸­
   - ç”¨äºå…¼å®¹æ€§åˆ¤æ–­

2. **æ—¶åŒºä¿¡æ¯åŒæ­¥** (`sync-timezone`)
   - æ£€æµ‹æ•°æ®åº“æ—¶åŒºè®¾ç½®
   - ç¡®ä¿æŸ¥è¯¢ç»“æœçš„æ—¶é—´å‡†ç¡®æ€§

3. **è¡¨ç»“æ„åŒæ­¥** (`sync-tables`)
   - åˆ›å»ºæˆ–æ›´æ–°è¡¨æ¨¡å‹
   - å¤„ç†è¡¨çš„å¯è§æ€§å’Œæƒé™
   - åŒæ­¥è¡¨çš„æè¿°ä¿¡æ¯

4. **å­—æ®µä¿¡æ¯åŒæ­¥** (`sync-fields`)
   - åˆ†æå­—æ®µçš„æ•°æ®ç±»å‹
   - è®¾ç½®å­—æ®µçš„è¯­ä¹‰ç±»å‹
   - å¤„ç†åµŒå¥—å­—æ®µç»“æ„

5. **å¤–é”®å…³ç³»åŒæ­¥** (`sync-fks`)
   - å»ºç«‹è¡¨é—´å…³è”å…³ç³»
   - éªŒè¯å¤–é”®çº¦æŸå®Œæ•´æ€§
   - æ›´æ–°å­—æ®µçš„FKå±æ€§

6. **ç´¢å¼•ä¿¡æ¯åŒæ­¥** (`sync-indexes`)
   - æ£€æµ‹å’ŒåŒæ­¥ç´¢å¼•å®šä¹‰
   - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½åˆ†æ
   - å¤„ç†å¤åˆç´¢å¼•å’Œå‡½æ•°ç´¢å¼•

**èŠ‚æ¥æº**
- [sync_metadata.clj](file://src/metabase/sync/sync_metadata.clj#L40-L78)

## é©±åŠ¨ç¨‹åºæ¥å£

### describe-databaseæ¥å£

æ‰€æœ‰æ•°æ®åº“é©±åŠ¨å¿…é¡»å®ç°çš„æ ¸å¿ƒæ¥å£ï¼š

```mermaid
classDiagram
class DatabaseDriver {
+describe-database(database) DatabaseMetadata
+describe-table(driver, database, table) TableMetadata
+describe-fields(driver, database, options) FieldMetadata
+describe-fks(driver, database, options) FKMetadata
+describe-table-indexes(driver, database, table) IndexMetadata
}
class DatabaseMetadata {
+tables Set~DatabaseMetadataTable~
+version String
}
class TableMetadata {
+name String
+schema String
+fields Set~FieldMetadata~
+description String
+estimated_row_count Integer
}
class FieldMetadata {
+name String
+database-type String
+base-type BaseType
+semantic-type SemanticType
+pk? Boolean
+field-comment String
}
DatabaseDriver --> DatabaseMetadata
DatabaseMetadata --> TableMetadata
TableMetadata --> FieldMetadata
```

**å›¾è¡¨æ¥æº**
- [interface.clj](file://src/metabase/sync/interface.clj#L10-L49)
- [driver.clj](file://src/metabase/driver.clj#L286-L313)

### å…ƒæ•°æ®æå–æµç¨‹

```mermaid
flowchart TD
Start([å¼€å§‹å…ƒæ•°æ®æå–]) --> GetDriver[è·å–æ•°æ®åº“é©±åŠ¨]
GetDriver --> CheckSupport{æ£€æŸ¥é©±åŠ¨æ”¯æŒ}
CheckSupport --> |æ”¯æŒdescribe-fields| FastPath[å¿«é€Ÿè·¯å¾„]
CheckSupport --> |ä¸æ”¯æŒ| LegacyPath[ä¼ ç»Ÿè·¯å¾„]
FastPath --> DescribeFields[è°ƒç”¨describe-fields]
LegacyPath --> DescribeTables[è°ƒç”¨describe-table]
DescribeFields --> ValidateOutput[éªŒè¯è¾“å‡ºæ ¼å¼]
DescribeTables --> ValidateOutput
ValidateOutput --> ProcessFields[å¤„ç†å­—æ®µå…ƒæ•°æ®]
ProcessFields --> AddPKs[æ·»åŠ ä¸»é”®ä¿¡æ¯]
AddPKs --> AddNested[å¤„ç†åµŒå¥—å­—æ®µ]
AddNested --> Complete([å…ƒæ•°æ®æå–å®Œæˆ])
```

**å›¾è¡¨æ¥æº**
- [fetch_metadata.clj](file://src/metabase/sync/fetch_metadata.clj#L50-L126)
- [describe_table.clj](file://src/metabase/driver/sql_jdbc/sync/describe_table.clj#L354-L385)

**èŠ‚æ¥æº**
- [fetch_metadata.clj](file://src/metabase/sync/fetch_metadata.clj#L25-L126)
- [driver.clj](file://src/metabase/driver.clj#L286-L313)

## åŒæ­¥ç±»å‹ä¸åˆ¤æ–­é€»è¾‘

### å…¨é‡åŒæ­¥ vs å¢é‡åŒæ­¥

Metabaseæ ¹æ®ä¸åŒçš„åœºæ™¯é‡‡ç”¨ä¸åŒçš„åŒæ­¥ç­–ç•¥ï¼š

| åŒæ­¥ç±»å‹ | è§¦å‘æ¡ä»¶ | åŒ…å«å†…å®¹ | æ€§èƒ½å½±å“ |
|---------|---------|---------|---------|
| å…¨é‡åŒæ­¥ | æ•°æ®åº“é¦–æ¬¡è¿æ¥ã€æ‰‹åŠ¨è§¦å‘ | æ‰€æœ‰å…ƒæ•°æ®ã€å­—æ®µå€¼ã€åˆ†æç»“æœ | é«˜ |
| å¢é‡åŒæ­¥ | å®šæ—¶ä»»åŠ¡ã€å­—æ®µå€¼ç¼“å­˜ | å˜æ›´çš„å…ƒæ•°æ®ã€æ–°å¢å­—æ®µ | ä¸­ç­‰ |
| è¡¨çº§åŒæ­¥ | å•è¡¨æ›´æ–°ã€æ–°è¡¨å‘ç° | ç‰¹å®šè¡¨çš„å®Œæ•´å…ƒæ•°æ® | ä½ |

### is_full_syncåˆ¤æ–­é€»è¾‘

```mermaid
flowchart TD
Start([å¼€å§‹åŒæ­¥åˆ¤æ–­]) --> CheckFlag{æ£€æŸ¥is_full_syncæ ‡å¿—}
CheckFlag --> |true| FullSync[æ‰§è¡Œå…¨é‡åŒæ­¥]
CheckFlag --> |false| IncrementalSync[æ‰§è¡Œå¢é‡åŒæ­¥]
FullSync --> SyncAllTables[åŒæ­¥æ‰€æœ‰è¡¨]
FullSync --> UpdateFieldValues[æ›´æ–°å­—æ®µå€¼]
FullSync --> RunAnalysis[è¿è¡Œæ•°æ®åˆ†æ]
IncrementalSync --> SyncChangedTables[åŒæ­¥å˜æ›´è¡¨]
IncrementalSync --> UpdateFieldValuesOnly[ä»…æ›´æ–°å­—æ®µå€¼]
SyncAllTables --> Complete([åŒæ­¥å®Œæˆ])
UpdateFieldValues --> Complete
RunAnalysis --> Complete
SyncChangedTables --> Complete
UpdateFieldValuesOnly --> Complete
```

**å›¾è¡¨æ¥æº**
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj#L106-L132)

**èŠ‚æ¥æº**
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj#L106-L132)

## é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥

### å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†

```mermaid
graph TD
Error[åŒæ­¥å¼‚å¸¸] --> Classify{å¼‚å¸¸åˆ†ç±»}
Classify --> Recoverable[å¯æ¢å¤å¼‚å¸¸]
Classify --> NonRecoverable[ä¸å¯æ¢å¤å¼‚å¸¸]
Recoverable --> Retry[é‡è¯•æœºåˆ¶]
Recoverable --> LogWarning[è®°å½•è­¦å‘Šæ—¥å¿—]
NonRecoverable --> Abort[ç»ˆæ­¢åŒæ­¥]
NonRecoverable --> MarkAborted[æ ‡è®°ä¸ºå¤±è´¥]
Retry --> Backoff[æŒ‡æ•°é€€é¿]
Backoff --> MaxRetries{è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°?}
MaxRetries --> |å¦| Retry
MaxRetries --> |æ˜¯| MarkAborted
LogWarning --> Continue[ç»§ç»­å…¶ä»–åŒæ­¥]
MarkAborted --> NotifyUser[é€šçŸ¥ç”¨æˆ·]
Continue --> Complete([åŒæ­¥å®Œæˆ])
NotifyUser --> Complete
```

**å›¾è¡¨æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L180-L242)

### é‡è¯•ç­–ç•¥é…ç½®

ç³»ç»Ÿé¢„å®šä¹‰äº†ä¸å¯é‡è¯•çš„å¼‚å¸¸ç±»å‹ï¼š

| å¼‚å¸¸ç±»å‹ | æè¿° | å¤„ç†ç­–ç•¥ |
|---------|------|---------|
| ConnectException | è¿æ¥è¶…æ—¶ | ç«‹å³ç»ˆæ­¢ |
| NoRouteToHostException | ç½‘ç»œä¸é€š | ç«‹å³ç»ˆæ­¢ |
| UnknownHostException | DNSè§£æå¤±è´¥ | ç«‹å³ç»ˆæ­¢ |
| SSLHandshakeException | SSLæ¡æ‰‹å¤±è´¥ | ç«‹å³ç»ˆæ­¢ |
| CannotAcquireResourceException | è¿æ¥æ± è€—å°½ | ç«‹å³ç»ˆæ­¢ |

### é”™è¯¯æ¢å¤æœºåˆ¶

```mermaid
sequenceDiagram
participant Sync as åŒæ­¥è¿›ç¨‹
participant ErrorHandler as é”™è¯¯å¤„ç†å™¨
participant Logger as æ—¥å¿—ç³»ç»Ÿ
participant UI as ç”¨æˆ·ç•Œé¢
Sync->>ErrorHandler : æŠ›å‡ºåŒæ­¥å¼‚å¸¸
ErrorHandler->>ErrorHandler : åˆ¤æ–­å¼‚å¸¸ç±»å‹
alt å¯æ¢å¤å¼‚å¸¸
ErrorHandler->>Logger : è®°å½•è­¦å‘Šæ—¥å¿—
ErrorHandler->>Sync : ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
else ä¸å¯æ¢å¤å¼‚å¸¸
ErrorHandler->>Logger : è®°å½•é”™è¯¯æ—¥å¿—
ErrorHandler->>Sync : ç»ˆæ­¢å½“å‰åŒæ­¥
ErrorHandler->>UI : æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
end
Sync->>Sync : æ›´æ–°åŒæ­¥çŠ¶æ€
Sync-->>UI : è¿”å›æœ€ç»ˆç»“æœ
```

**å›¾è¡¨æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L180-L242)

**èŠ‚æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L180-L242)

## UIçŠ¶æ€å±•ç¤º

### åŒæ­¥çŠ¶æ€è·Ÿè¸ª

Metabaseæä¾›äº†å®Œæ•´çš„åŒæ­¥çŠ¶æ€å¯è§†åŒ–ï¼š

```mermaid
stateDiagram-v2
[*] --> Pending : å¼€å§‹åŒæ­¥
Pending --> Running : åŒæ­¥è¿›è¡Œä¸­
Running --> Completed : åŒæ­¥æˆåŠŸ
Running --> Failed : åŒæ­¥å¤±è´¥
Running --> Aborted : ç”¨æˆ·ä¸­æ–­
Completed --> [*]
Failed --> [*]
Aborted --> [*]
note right of Running : æ˜¾ç¤ºè¿›åº¦æ¡<br/>æ˜¾ç¤ºå½“å‰æ­¥éª¤<br/>æ˜¾ç¤ºé¢„è®¡å‰©ä½™æ—¶é—´
note right of Completed : æ˜¾ç¤ºåŒæ­¥æ—¶é—´<br/>æ˜¾ç¤ºæ›´æ–°çš„é¡¹ç›®æ•°<br/>æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
note right of Failed : æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…<br/>æ˜¾ç¤ºé‡è¯•é€‰é¡¹<br/>æ˜¾ç¤ºå¸®åŠ©é“¾æ¥
```

### è¿›åº¦æŒ‡ç¤ºå™¨

ç³»ç»Ÿä½¿ç”¨è¡¨æƒ…ç¬¦å·è¿›åº¦æ¡æä¾›ç›´è§‚çš„è¿›åº¦åé¦ˆï¼š

| è¿›åº¦èŒƒå›´ | è¡¨æƒ…ç¬¦å· | å«ä¹‰ |
|---------|---------|------|
| 0-10% | ğŸ˜± | åŒæ­¥å¼€å§‹ï¼Œå‹åŠ›å±±å¤§ |
| 10-30% | ğŸ˜¢ | è¿›åº¦ç¼“æ…¢ï¼Œè€å¿ƒç­‰å¾… |
| 30-50% | ğŸ˜ | ä¸­é€”çŠ¶æ€ï¼Œç»§ç»­åŠªåŠ› |
| 50-70% | ğŸ˜ | åŠç¨‹å®Œæˆï¼Œå³å°†ç»“æŸ |
| 70-90% | ğŸ˜Š | æ¥è¿‘å®Œæˆï¼Œå†åšæŒä¸€ä¸‹ |
| 90-100% | ğŸ˜ | å¿«é€Ÿå®Œæˆï¼Œå®Œç¾æ”¶å°¾ |

### çŠ¶æ€æŒä¹…åŒ–

```mermaid
erDiagram
DATABASE {
uuid id PK
string name
string initial_sync_status
timestamp last_sync
boolean is_full_sync
}
TABLE {
uuid id PK
uuid db_id FK
string name
string initial_sync_status
timestamp last_sync
}
SYNC_LOG {
uuid id PK
uuid database_id FK
string operation_type
timestamp start_time
timestamp end_time
string status
text details
}
DATABASE ||--o{ TABLE : contains
DATABASE ||--o{ SYNC_LOG : records
```

**å›¾è¡¨æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L343-L368)

**èŠ‚æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L261-L319)
- [util.clj](file://src/metabase/sync/util.clj#L343-L368)

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### å¤§å‹æ•°æ®åº“çš„åˆ†æ‰¹å¤„ç†

å¯¹äºåŒ…å«å¤§é‡è¡¨çš„å¤§æ•°æ®åº“ï¼Œç³»ç»Ÿé‡‡ç”¨äº†æ™ºèƒ½çš„åˆ†æ‰¹å¤„ç†ç­–ç•¥ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹å¤§æ‰¹é‡åŒæ­¥]) --> CountTables[ç»Ÿè®¡è¡¨æ•°é‡]
CountTables --> CheckBatchSize{è¡¨æ•°é‡ > æ‰¹é‡å¤§å°?}
CheckBatchSize --> |å¦| DirectSync[ç›´æ¥åŒæ­¥æ‰€æœ‰è¡¨]
CheckBatchSize --> |æ˜¯| BatchSync[åˆ†æ‰¹åŒæ­¥]
BatchSync --> CreateBatches[åˆ›å»ºæ‰¹æ¬¡]
CreateBatches --> ProcessBatch[å¤„ç†å•ä¸ªæ‰¹æ¬¡]
ProcessBatch --> UpdateStatus[æ›´æ–°æ‰¹æ¬¡çŠ¶æ€]
UpdateStatus --> MoreBatches{è¿˜æœ‰æ›´å¤šæ‰¹æ¬¡?}
MoreBatches --> |æ˜¯| ProcessBatch
MoreBatches --> |å¦| FinalUpdate[æ‰¹é‡æ›´æ–°å®ŒæˆçŠ¶æ€]
DirectSync --> UpdateStatus
FinalUpdate --> Complete([åŒæ­¥å®Œæˆ])
```

**å›¾è¡¨æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L330-L342)

### å­—æ®µå€¼ç¼“å­˜ç­–ç•¥

```mermaid
graph LR
subgraph "å­—æ®µå€¼ç¼“å­˜å±‚æ¬¡"
L1[åŸºç¡€ç¼“å­˜] --> L2[é«˜çº§ç¼“å­˜]
L2 --> L3[æ·±åº¦åˆ†æ]
end
subgraph "ç¼“å­˜ç±»å‹"
Basic[åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯]
Unique[å”¯ä¸€å€¼åˆ—è¡¨]
Advanced[é«˜çº§åˆ†ææŒ‡æ ‡]
end
L1 -.-> Basic
L2 -.-> Unique
L3 -.-> Advanced
```

### æ€§èƒ½ä¼˜åŒ–é…ç½®

| ä¼˜åŒ–é¡¹ | é»˜è®¤å€¼ | å¯è°ƒå‚æ•° | å½±å“èŒƒå›´ |
|-------|-------|---------|---------|
| æ‰¹é‡å¤§å° | 20000 | *batch-size* | è¡¨æ›´æ–°æ€§èƒ½ |
| å¹¶å‘è¿æ¥æ•° | åŠ¨æ€ | é©±åŠ¨ç¨‹åºé…ç½® | ç½‘ç»œI/Oæ•ˆç‡ |
| è¶…æ—¶æ—¶é—´ | 30ç§’ | é©±åŠ¨ç¨‹åºé…ç½® | ç½‘ç»œç¨³å®šæ€§ |
| é‡è¯•æ¬¡æ•° | 3æ¬¡ | å†…ç½®é€»è¾‘ | é”™è¯¯æ¢å¤èƒ½åŠ› |

**èŠ‚æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L330-L342)
- [field_values.clj](file://src/metabase/sync/field_values.clj#L1-L129)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

```mermaid
flowchart TD
Problem[åŒæ­¥é—®é¢˜] --> CheckNetwork{ç½‘ç»œè¿æ¥æ­£å¸¸?}
CheckNetwork --> |å¦| NetworkFix[æ£€æŸ¥ç½‘ç»œé…ç½®]
CheckNetwork --> |æ˜¯| CheckCredentials{è®¤è¯å‡­æ®æ­£ç¡®?}
CheckCredentials --> |å¦| AuthFix[æ›´æ–°è®¤è¯ä¿¡æ¯]
CheckCredentials --> |æ˜¯| CheckDriver{é©±åŠ¨ç¨‹åºå…¼å®¹?}
CheckDriver --> |å¦| UpdateDriver[æ›´æ–°é©±åŠ¨ç¨‹åº]
CheckDriver --> |æ˜¯| CheckLogs[æŸ¥çœ‹è¯¦ç»†æ—¥å¿—]
NetworkFix --> TestConnection[æµ‹è¯•è¿æ¥]
AuthFix --> TestConnection
UpdateDriver --> TestConnection
CheckLogs --> AnalyzeErrors[åˆ†æé”™è¯¯æ¨¡å¼]
TestConnection --> Success{æµ‹è¯•æˆåŠŸ?}
Success --> |æ˜¯| Resolved[é—®é¢˜è§£å†³]
Success --> |å¦| EscalateIssue[å‡çº§é—®é¢˜]
AnalyzeErrors --> Resolved
EscalateIssue --> ContactSupport[è”ç³»æŠ€æœ¯æ”¯æŒ]
```

### è°ƒè¯•å·¥å…·ä¸æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```clojure
   (binding [sync-util/*log-exceptions-and-continue?* false]
     ;; æ‰§è¡ŒåŒæ­¥æ“ä½œ
     )
   ```

2. **æ£€æŸ¥åŒæ­¥çŠ¶æ€**
   ```sql
   SELECT id, name, initial_sync_status, last_sync 
   FROM metabase_database 
   WHERE id = ?;
   ```

3. **ç›‘æ§ä»»åŠ¡é˜Ÿåˆ—**
   - æŸ¥çœ‹Quartzè°ƒåº¦å™¨çŠ¶æ€
   - æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œå†å²
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼ | ç›‘æ§æ–¹æ³• |
|---------|---------|---------|---------|
| åŒæ­¥æ—¶é—´ | < 30åˆ†é’Ÿ | > 1å°æ—¶ | ä»»åŠ¡å†å²è®°å½• |
| é”™è¯¯ç‡ | < 5% | > 20% | é”™è¯¯æ—¥å¿—ç»Ÿè®¡ |
| å†…å­˜ä½¿ç”¨ | < 80% | > 90% | JVMç›‘æ§ |
| CPUä½¿ç”¨ | < 70% | > 90% | ç³»ç»Ÿç›‘æ§ |

**èŠ‚æ¥æº**
- [util.clj](file://src/metabase/sync/util.clj#L180-L242)
- [sync_databases.clj](file://src/metabase/sync/task/sync_databases.clj#L60-L100)

## ç»“è®º

Metabaseçš„æ•°æ®åº“åŒæ­¥æœºåˆ¶æ˜¯ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–å’Œå¯æ‰©å±•çš„ç³»ç»Ÿï¼Œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„å®ç°äº†é«˜æ•ˆã€å¯é çš„å…ƒæ•°æ®åŒæ­¥åŠŸèƒ½ã€‚è¯¥ç³»ç»Ÿä¸ä»…æ”¯æŒå¤šç§æ•°æ®åº“ç±»å‹çš„æ— ç¼é›†æˆï¼Œè¿˜æä¾›äº†å®Œå–„çš„é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒä¿éšœæœºåˆ¶ã€‚

å…³é”®ç‰¹æ€§æ€»ç»“ï¼š
- **è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜**ï¼šæ”¯æŒå®šæ—¶è‡ªåŠ¨åŒæ­¥å’Œæ‰‹åŠ¨è§¦å‘åŒæ­¥
- **å®¹é”™èƒ½åŠ›å¼º**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **æ€§èƒ½ä¼˜åŒ–å¥½**ï¼šåˆ†æ‰¹å¤„ç†å’Œç¼“å­˜ç­–ç•¥æå‡å¤§æ•°æ®åº“å¤„ç†èƒ½åŠ›
- **ç”¨æˆ·ä½“éªŒä½³**ï¼šå®æ—¶çŠ¶æ€åé¦ˆå’Œè¯¦ç»†çš„è¿›åº¦æŒ‡ç¤º
- **æ‰©å±•æ€§å¼º**ï¼šæ ‡å‡†åŒ–çš„é©±åŠ¨ç¨‹åºæ¥å£æ”¯æŒæ–°æ•°æ®åº“ç±»å‹æ¥å…¥

é€šè¿‡æŒç»­çš„ä¼˜åŒ–å’Œæ”¹è¿›ï¼Œè¯¥åŒæ­¥æœºåˆ¶èƒ½å¤Ÿæ»¡è¶³ä»å°å‹é¡¹ç›®åˆ°ä¼ä¸šçº§å¤§æ•°æ®ç¯å¢ƒçš„å„ç§éœ€æ±‚ï¼Œä¸ºç”¨æˆ·æä¾›ç¨³å®šå¯é çš„æ•°æ®åº“å…ƒæ•°æ®ç®¡ç†æœåŠ¡ã€‚