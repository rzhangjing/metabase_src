# 虚拟数据库支持

<cite>
**本文档中引用的文件**   
- [table.clj](file://src/metabase/warehouse_schema/table.clj)
- [api.clj](file://src/metabase/warehouses/api.clj)
- [bootstrap.clj](file://src/metabase/lib_be/metadata/bootstrap.clj)
- [setup.clj](file://src/metabase/query_processor/setup.clj)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [虚拟数据库元数据生成机制](#虚拟数据库元数据生成机制)
4. [前端集成方式](#前端集成方式)
5. [权限控制细节](#权限控制细节)
6. [实际使用场景和代码示例](#实际使用场景和代码示例)
7. [结论](#结论)

## 简介
Metabase系统通过虚拟数据库机制，将保存的查询卡片（Cards）作为虚拟表暴露给查询构建器。这种机制允许用户将已保存的查询结果视为普通数据库表进行操作，从而实现查询的嵌套和复用。虚拟数据库的核心功能由`saved-cards-virtual-db-metadata`和`card->virtual-table`等函数实现，这些函数负责生成虚拟数据库的元数据，包括表结构、字段信息和权限过滤规则。

## 核心组件

虚拟数据库支持的核心组件包括`card->virtual-table`和`saved-cards-virtual-db-metadata`函数。`card->virtual-table`函数负责将单个卡片转换为虚拟表的元数据，而`saved-cards-virtual-db-metadata`函数则负责生成整个虚拟数据库的元数据。这些函数通过查询处理器的设置和元数据提供者协同工作，确保虚拟数据库能够正确解析和执行查询。

**Section sources**
- [table.clj](file://src/metabase/warehouse_schema/table.clj#L106-L133)
- [api.clj](file://src/metabase/warehouses/api.clj#L194-L207)

## 虚拟数据库元数据生成机制

虚拟数据库的元数据生成机制通过`card->virtual-table`函数实现。该函数接收一个卡片对象，并返回一个包含虚拟表元数据的映射。元数据包括表的ID、显示名称、模式、描述、实体ID、指标和类型等信息。如果请求包含数据库和字段信息，函数还会关联实际的数据库对象和字段元数据。

```mermaid
flowchart TD
A[输入卡片对象] --> B{是否包含数据库信息?}
B --> |是| C[关联实际数据库对象]
B --> |否| D[仅返回基本元数据]
C --> E{是否包含字段信息?}
E --> |是| F[生成虚拟字段元数据]
E --> |否| G[不包含字段信息]
F --> H[返回完整的虚拟表元数据]
G --> H
D --> H
```

**Diagram sources **
- [table.clj](file://src/metabase/warehouse_schema/table.clj#L106-L133)

**Section sources**
- [table.clj](file://src/metabase/warehouse_schema/table.clj#L106-L133)

## 前端集成方式

前端通过API端点与虚拟数据库进行集成。系统提供了多个端点来获取虚拟数据库的元数据，包括`/:virtual-db/metadata`、`/:virtual-db/schemas`和`/:virtual-db/datasets`等。这些端点允许前端将虚拟数据库视为普通数据库进行操作，获取其模式、数据集和表信息。

```mermaid
graph TB
A[前端] --> B[API请求]
B --> C{请求类型}
C --> D[获取元数据]
C --> E[获取模式]
C --> F[获取数据集]
D --> G[返回虚拟数据库元数据]
E --> H[返回模式列表]
F --> I[返回数据集列表]
G --> J[前端显示]
H --> J
I --> J
```

**Diagram sources **
- [api.clj](file://src/metabase/warehouses/api.clj#L510-L529)
- [api.clj](file://src/metabase/warehouses/api.clj#L1215-L1242)

**Section sources**
- [api.clj](file://src/metabase/warehouses/api.clj#L510-L529)
- [api.clj](file://src/metabase/warehouses/api.clj#L1215-L1242)

## 权限控制细节

权限控制通过`filter-databases-by-data-model-perms`函数实现。当用户没有数据访问权限时，系统会返回有限的元数据信息，仅包含数据库的名称和ID。对于有权限的用户，系统会返回完整的数据库信息，包括表和字段的详细信息。

```mermaid
graph TD
A[用户请求] --> B{是否有数据访问权限?}
B --> |是| C[返回完整数据库信息]
B --> |否| D[返回有限元数据]
C --> E[包含表和字段信息]
D --> F[仅包含名称和ID]
E --> G[前端显示完整信息]
F --> G
```

**Diagram sources **
- [api.clj](file://src/metabase/warehouses/api.clj#L201-L225)

**Section sources**
- [api.clj](file://src/metabase/warehouses/api.clj#L201-L225)

## 实际使用场景和代码示例

在实际使用中，用户可以通过查询构建器选择虚拟数据库中的表进行查询。系统会自动解析虚拟表的元数据，并将其转换为实际的查询。例如，当用户选择一个虚拟表时，系统会调用`card->virtual-table`函数生成元数据，并使用该元数据构建查询。

```mermaid
sequenceDiagram
participant 用户
participant 前端
participant API
participant 虚拟数据库
用户->>前端 : 选择虚拟表
前端->>API : 请求元数据
API->>虚拟数据库 : 调用card->virtual-table
虚拟数据库-->>API : 返回元数据
API-->>前端 : 返回元数据
前端->>用户 : 显示查询界面
```

**Diagram sources **
- [table.clj](file://src/metabase/warehouse_schema/table.clj#L106-L133)
- [api.clj](file://src/metabase/warehouses/api.clj#L510-L529)

**Section sources**
- [table.clj](file://src/metabase/warehouse_schema/table.clj#L106-L133)
- [api.clj](file://src/metabase/warehouses/api.clj#L510-L529)

## 结论
Metabase的虚拟数据库支持机制通过将保存的查询卡片作为虚拟表暴露给查询构建器，实现了查询的嵌套和复用。该机制通过`card->virtual-table`和`saved-cards-virtual-db-metadata`等核心函数生成虚拟数据库的元数据，并通过API端点与前端集成。权限控制确保了用户只能访问其有权限的数据，同时在无权限时返回有限的元数据信息。这种设计使得用户能够方便地将已保存的查询结果作为普通数据库表进行操作，提高了查询的灵活性和复用性。