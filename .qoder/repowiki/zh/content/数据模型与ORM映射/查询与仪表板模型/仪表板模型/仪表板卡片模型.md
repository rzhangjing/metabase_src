# 仪表板卡片模型

<cite>
**本文档中引用的文件**  
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj)
- [dashboard_card_series.clj](file://src/metabase/dashboards/models/dashboard_card_series.clj)
- [constants.cljc](file://src/metabase/dashboards/constants.cljc)
- [parameters/core.clj](file://src/metabase/parameters/core.clj)
- [serialization.clj](file://src/metabase/models/serialization.clj)
</cite>

## 目录
1. [引言](#引言)
2. [核心数据结构](#核心数据结构)
3. [参数映射机制](#参数映射机制)
4. [可视化配置](#可视化配置)
5. [多系列支持](#多系列支持)
6. [卡片布局属性](#卡片布局属性)
7. [与底层查询模型的关联](#与底层查询模型的关联)
8. [序列化与数据转换](#序列化与数据转换)

## 引言
本文档详细分析 Metabase 系统中仪表板卡片（Dashboard Card）的数据结构与核心功能。仪表板卡片是 Metabase 中用于在仪表板上展示数据查询结果的核心组件，它不仅承载了查询的可视化展示，还实现了参数联动、多系列合并、布局管理等复杂功能。本文将重点解析 `parameter_mappings`（参数映射）、`visualization_settings`（可视化配置）和 `series`（多系列支持）等关键字段，并阐述卡片如何通过 `card_id` 关联底层查询模型（Card），以及多卡片系列的组织逻辑。

## 核心数据结构
仪表板卡片（`dashboard_card.clj`）是定义在 `:model/DashboardCard` 模型上的一个核心实体。其数据结构是一个包含多个关键字段的 Clojure 映射（map），这些字段共同决定了卡片在仪表板上的行为和外观。

核心字段包括：
- `id`: 卡片的唯一标识符。
- `dashboard_id`: 所属仪表板的 ID。
- `card_id`: 关联的底层查询模型（Card）的 ID，是实现查询复用的关键。
- `row`, `col`, `size_x`, `size_y`: 定义卡片在仪表板网格布局中的位置和大小。
- `parameter_mappings`: 存储参数映射关系的列表，用于实现仪表板参数与卡片查询的联动。
- `visualization_settings`: 一个嵌套的映射，存储所有与可视化相关的配置，如图表类型、颜色、轴标签等。
- `series`: 一个整数列表，包含作为附加系列添加到此卡片的其他查询卡片的 ID。

该模型在创建时通过 `t2/define-before-insert` 钩子为 `parameter_mappings`、`visualization_settings` 和 `inline_parameters` 字段设置了默认值，确保了数据的完整性。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L1-L50)

## 参数映射机制
`parameter_mappings` 字段是实现仪表板级参数与单个卡片查询联动的核心机制。它允许仪表板上的全局参数（如日期范围、地区选择）动态地影响其内部每个卡片的查询条件。

### 数据结构与转换
`parameter_mappings` 是一个包含多个映射（map）的列表，每个映射代表一个参数的映射关系。其结构通常包含：
- `parameter_id`: 仪表板参数的 ID。
- `card_id`: 被映射的卡片 ID（在 `dashboard_card.clj` 的上下文中，通常指代 `dashboard_card` 自身关联的 `card`）。
- `target`: 定义了参数如何应用到查询中的目标，例如，是替换查询中的某个过滤条件（`dimension`）还是作为变量。

在数据持久化和序列化过程中，`parameter_mappings` 会经过 `parameters/transform-parameter-mappings` 函数的转换。这个转换确保了参数映射在存储和传输时的格式一致性。在反序列化时，会通过 `serdes/import-parameter-mappings` 函数将其恢复为运行时可用的结构。

### 实现参数联动
当用户在仪表板上更改一个参数时，系统会遍历所有卡片的 `parameter_mappings` 列表。对于每个匹配的映射，系统会使用新的参数值来修改对应卡片查询的 `dataset_query`，然后重新执行查询并刷新卡片的可视化结果。这种机制实现了“一次选择，多处更新”的用户体验。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L10-L15)
- [parameters/core.clj](file://src/metabase/parameters/core.clj#L1-L14)

## 可视化配置
`visualization_settings` 字段是一个灵活的嵌套映射，用于存储所有与卡片可视化展示相关的非查询逻辑配置。它独立于查询本身，允许用户在不修改底层数据逻辑的情况下，自由地调整图表的外观和交互方式。

### 配置内容
该字段可以包含多种配置，例如：
- `display`: 指定图表类型，如 `line`（折线图）、`bar`（柱状图）、`table`（表格）等。
- `graph` 命名空间下的配置：如 `graph.series_labels`（系列标签）、`graph.x_axis.title_text`（X轴标题）等。
- `text` 命名空间下的配置：用于文本卡片，如 `text.align_vertical`（垂直对齐方式）。
- `click_behavior`：定义点击图表元素时的交互行为，如钻取到其他仪表板。

### 数据转换与标准化
与 `parameter_mappings` 类似，`visualization_settings` 在存储和读取时也会经过转换。`mi/transform-visualization-settings` 函数确保了其结构的规范性。在序列化过程中，会使用 `serdes/export-visualization-settings` 和 `serdes/import-visualization-settings` 进行编解码。此外，`mi/normalize-visualization-settings` 函数用于在运行时对传入的配置进行标准化处理，以保证系统内部处理的一致性。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L10-L15)
- [serialization.clj](file://src/metabase/models/serialization.clj#L1-L50)

## 多系列支持
Metabase 允许将多个查询卡片（Cards）合并到一个仪表板卡片（DashboardCard）中，形成一个包含多系列数据的复合图表。这一功能通过 `dashboard_card_series.clj` 模型和 `series` 字段实现。

### 组织逻辑
`dashboard_card_series.clj` 文件定义了 `:model/DashboardCardSeries` 模型，它是一个关联表，用于建立 `DashboardCard` 和 `Card` 之间的多对多关系。其核心字段包括：
- `dashboardcard_id`: 主仪表板卡片的 ID。
- `card_id`: 作为附加系列添加的查询卡片的 ID。
- `position`: 定义了该系列在图表中的显示顺序。

### 排序与分组
系列的排序由 `position` 字段严格控制。当创建或更新一个包含多系列的卡片时，系统会调用 `update-dashboard-cards-series!` 函数。该函数会先删除该卡片所有现有的系列关联，然后根据传入的 `card-ids` 列表的顺序，重新创建 `DashboardCardSeries` 记录，并将 `position` 设置为列表中的索引。这确保了系列的顺序与用户指定的完全一致。

渲染策略上，系统会首先获取主卡片（`card_id` 指向的卡片）的查询结果，然后依次获取 `series` 中每个卡片的查询结果，并将它们合并到同一个图表中进行渲染。主卡片通常决定了图表的基本类型和轴的定义。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L138-L160)
- [dashboard_card_series.clj](file://src/metabase/dashboards/models/dashboard_card_series.clj#L1-L25)

## 卡片布局属性
仪表板卡片的位置和大小由一组布局属性精确控制，这些属性遵循一个固定的网格系统。

### 属性定义
- `row`: 卡片左上角所在的行号（从0开始）。
- `col`: 卡片左上角所在的列号（从0开始）。
- `size_x`: 卡片占据的列数（宽度）。
- `size_y`: 卡片占据的行数（高度）。

### 渲染作用
在仪表板渲染时，前端会根据这些属性将卡片放置在预定义的网格上。网格的总宽度由 `constants.cljc` 文件中的 `GRID_WIDTH` 常量定义（通常为24列）。卡片的 `col` 和 `size_x` 属性决定了其水平位置和跨度，而 `row` 和 `size_y` 则决定了其垂直位置和高度。这种基于网格的布局确保了仪表板的整洁和响应式设计。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L184-L208)
- [constants.cljc](file://src/metabase/dashboards/constants.cljc#L1-L10)

## 与底层查询模型的关联
仪表板卡片通过 `card_id` 字段与底层的查询模型（`Card`）建立直接关联，这是实现查询结果复用的基础。

### 关联方式
`card_id` 是一个外键，它指向 `:model/Card` 表中的一个具体记录。`Card` 模型包含了完整的查询定义（`dataset_query`），例如 SQL 语句或 MBQL（Metabase Query Language）表达式。当仪表板需要渲染一个卡片时，系统会使用 `card_id` 从数据库中加载对应的 `Card` 实体，获取其查询逻辑，然后执行查询并获取结果。

### 查询复用与参数联动
这种关联方式实现了查询的复用。同一个 `Card` 可以被多个不同的 `DashboardCard` 引用，从而在多个仪表板或同一仪表板的不同位置展示相同的数据。同时，通过 `parameter_mappings`，仪表板的参数可以动态地修改这个被复用的查询，使其根据用户的选择返回不同的结果，实现了强大的交互性。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L1-L50)

## 序列化与数据转换
为了支持仪表板的导出、导入和跨实例迁移，`dashboard_card.clj` 实现了完整的序列化（serdes）协议。

### 序列化规范
`serdes/make-spec` 多方法为 `DashboardCard` 定义了详细的序列化规则：
- `:copy`: 指定需要直接复制的字段，如 `col`, `row`, `size_x`, `size_y` 等布局属性。
- `:transform`: 指定需要特殊处理的字段。例如，`card_id` 会被转换为对 `Card` 模型的引用（`serdes/fk :model/Card`），`parameter_mappings` 和 `visualization_settings` 会使用专门的导出/导入函数进行处理。
- `:series`: 通过 `serdes/nested` 指令，将 `DashboardCardSeries` 记录作为嵌套数据包含在 `DashboardCard` 的序列化输出中，确保了多系列信息的完整性。

### 数据转换流程
在序列化过程中，`parameter_mappings` 和 `visualization_settings` 等复杂结构会先被规范化（normalize），然后通过特定的转换函数（如 `export-parameter-mappings`）转换为适合 JSON/YAML 存储的格式。在反序列化（导入）时，流程则相反，系统会调用相应的导入函数（如 `import-parameter-mappings`）将数据恢复为运行时可用的内部结构。

**Section sources**
- [dashboard_card.clj](file://src/metabase/dashboards/models/dashboard_card.clj#L396-L409)
- [serialization.clj](file://src/metabase/models/serialization.clj#L1-L50)