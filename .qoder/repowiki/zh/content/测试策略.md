# 测试策略

<cite>
**本文档中引用的文件**   
- [api.clj](file://src/metabase/testing_api/api.clj)
- [core.clj](file://src/metabase/testing_api/core.clj)
- [init.clj](file://src/metabase/testing_api/init.clj)
- [settings.clj](file://src/metabase/testing_api/settings.clj)
- [config.clj](file://src/metabase/config/core.clj)
</cite>

## 目录
1. [介绍](#介绍)
2. [测试方法和框架](#测试方法和框架)
3. [测试API模块](#测试api模块)
4. [测试组织结构](#测试组织结构)
5. [测试初始化逻辑](#测试初始化逻辑)
6. [编写新测试的指南](#编写新测试的指南)
7. [测试在代码质量保证中的作用](#测试在代码质量保证中的作用)

## 介绍
本文档旨在详细介绍Metabase项目的测试策略，包括采用的测试方法、框架以及相关基础设施。重点介绍`testing_api`模块如何为集成测试提供后门API，用于设置测试数据和状态。同时描述单元测试、集成测试和端到端测试的组织结构和运行方式，解释如何使用测试专用的设置和数据初始化逻辑（`test_initializer`），并提供编写新测试的最佳实践指南。

## 测试方法和框架
Metabase项目采用多种测试方法来确保代码质量和防止回归问题。测试框架主要基于Clojure的测试库，并结合了Cypress进行端到端测试。测试环境通过配置文件和环境变量进行管理，确保在不同环境下的一致性。

**Section sources**
- [config.clj](file://src/metabase/config/core.clj#L195-L233)

## 测试API模块
`testing_api`模块为集成测试提供了后门API，允许测试代码直接与应用程序数据库交互，设置测试数据和状态。该模块包含多个端点，用于保存和恢复数据库快照、设置时间、标记卡片或仪表板为陈旧等。

### 数据库快照
`/api/testing/snapshot/:name`端点用于保存当前数据库状态的快照，而`/api/testing/restore/:name`端点用于从指定快照恢复数据库。这些功能仅适用于H2数据库，确保测试环境的一致性和可重复性。

### 时间控制
`/api/testing/set-time`端点允许测试代码设置系统时间，这对于测试时间敏感的功能非常有用。通过此端点，可以模拟不同的时间点，验证应用程序的行为。

### 状态标记
`/api/testing/mark-stale`端点用于标记卡片或仪表板为陈旧，帮助测试缓存和更新机制。

**Section sources**
- [api.clj](file://src/metabase/testing_api/api.clj#L0-L205)

## 测试组织结构
测试组织结构分为单元测试、集成测试和端到端测试三个层次。每个层次都有明确的职责和运行方式，确保全面覆盖应用程序的各个方面。

### 单元测试
单元测试专注于单个函数或组件的功能验证，通常不依赖外部系统。这些测试快速且可靠，用于确保基本功能的正确性。

### 集成测试
集成测试验证多个组件之间的交互，确保它们协同工作。这些测试可能涉及数据库、网络请求等外部系统，运行时间较长但能发现更复杂的问题。

### 端到端测试
端到端测试模拟真实用户操作，从用户界面到后端服务进行全面验证。Cypress框架用于自动化这些测试，确保用户流程的完整性和正确性。

**Section sources**
- [api.clj](file://src/metabase/testing_api/api.clj#L0-L205)

## 测试初始化逻辑
测试专用的设置和数据初始化逻辑通过`test_initializer`模块实现。该模块负责在测试开始前准备必要的数据和配置，确保每次测试都在一致的环境中运行。初始化过程包括创建测试用户、设置测试数据、配置测试环境等。

**Section sources**
- [settings.clj](file://src/metabase/testing_api/settings.clj#L0-L10)

## 编写新测试的指南
编写新测试时，应遵循以下最佳实践：

### 模拟
使用模拟技术隔离测试组件，避免对外部系统的依赖。这可以提高测试速度和可靠性。

### 数据夹具
使用数据夹具（fixtures）提供一致的测试数据，确保测试结果的可预测性。数据夹具应包含所有必要的数据，以支持测试场景。

### 最佳实践
- **独立性**：每个测试应独立运行，不依赖其他测试的结果。
- **清晰性**：测试代码应清晰易懂，便于维护和调试。
- **覆盖率**：确保测试覆盖关键路径和边界条件，提高代码质量。

**Section sources**
- [api.clj](file://src/metabase/testing_api/api.clj#L0-L205)

## 测试在代码质量保证中的作用
测试在保证代码质量和防止回归中起着至关重要的作用。通过全面的测试覆盖，可以及早发现和修复问题，减少生产环境中的故障。此外，测试还提供了文档功能，帮助开发人员理解代码行为和预期结果。

**Section sources**
- [api.clj](file://src/metabase/testing_api/api.clj#L0-L205)
- [settings.clj](file://src/metabase/testing_api/settings.clj#L0-L10)