# Metabase云环境迁移流程详细指南

<cite>
**本文档中引用的文件**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj)
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj)
- [migrate.clj](file://src/metabase/cmd/migrate.clj)
- [impl.clj](file://src/metabase/task/impl.clj)
- [settings.clj](file://src/metabase/cloud_migration/settings.clj)
- [core.clj](file://src/metabase/task/core.clj)
- [copy_h2.clj](file://src/metabase/cmd/copy/h2.clj)
- [load_from_h2.clj](file://src/metabase/cmd/load_from_h2.clj)
- [update_h2.clj](file://src/metabase/app_db/update_h2.clj)
</cite>

## 目录
1. [概述](#概述)
2. [迁移前准备](#迁移前准备)
3. [迁移流程架构](#迁移流程架构)
4. [详细迁移步骤](#详细迁移步骤)
5. [任务调度器管理](#任务调度器管理)
6. [H2数据库备份处理](#h2数据库备份处理)
7. [安全上传机制](#安全上传机制)
8. [数据一致性保障](#数据一致性保障)
9. [验证检查点](#验证检查点)
10. [故障排除指南](#故障排除指南)
11. [最佳实践建议](#最佳实践建议)

## 概述

Metabase从本地实例迁移到云环境是一个复杂的过程，涉及多个关键步骤：进入只读模式、停止任务调度器、生成H2数据库备份、安全上传备份文件等。本指南详细说明了整个迁移流程，确保数据完整性和系统稳定性。

### 迁移目标
- 将本地Metabase实例完整迁移到云环境
- 确保迁移过程中的数据一致性
- 最小化服务中断时间
- 提供完整的回滚机制

## 迁移前准备

### 系统状态检查

在开始迁移之前，需要进行以下准备工作：

```mermaid
flowchart TD
A["系统健康检查"] --> B["确认集群状态"]
B --> C["检查数据库连接"]
C --> D["验证存储空间"]
D --> E["备份当前配置"]
E --> F["准备迁移环境"]
G["权限验证"] --> H["管理员权限"]
H --> I["数据库访问权限"]
I --> J["存储上传权限"]
J --> K["网络连接测试"]
```

**节源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L108-L115)

### 配置验证

迁移前需要验证以下配置项：
- 存储API URL配置
- AWS KMS加密设置
- 分块上传阈值配置
- 版本兼容性检查

## 迁移流程架构

### 整体架构图

```mermaid
graph TB
subgraph "本地实例"
A[应用服务器] --> B[数据库引擎]
B --> C[H2数据库]
A --> D[任务调度器]
end
subgraph "迁移控制流程"
E[迁移控制器] --> F[只读模式设置]
F --> G[调度器停止]
G --> H[H2备份生成]
H --> I[文件上传]
I --> J[调度器重启]
end
subgraph "云环境"
K[存储服务] --> L[备份文件]
M[新实例] --> N[恢复数据库]
end
A -.-> E
H -.-> K
N -.-> L
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L219-L249)

### 核心组件关系

```mermaid
classDiagram
class CloudMigration {
+UUID id
+String external_id
+String state
+Integer progress
+String upload_url
+migrate!()
+get-store-migration()
}
class TaskScheduler {
+stop-scheduler!()
+start-scheduler!()
+init-scheduler!()
+scheduler-info()
}
class H2Dumper {
+dump-to-h2!()
+delete-existing-h2-database-files!()
+h2-data-source()
}
class StorageUploader {
+upload()
+put-file()
+multipart-upload()
}
CloudMigration --> TaskScheduler : "控制"
CloudMigration --> H2Dumper : "使用"
CloudMigration --> StorageUploader : "依赖"
TaskScheduler --> H2Dumper : "协调"
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L1-L50)
- [impl.clj](file://src/metabase/task/impl.clj#L1-L50)

## 详细迁移步骤

### 第一阶段：进入只读模式

#### 设置只读模式

迁移的第一步是将Metabase实例设置为只读模式，防止在备份过程中发生数据写入：

```mermaid
sequenceDiagram
participant MC as 迁移控制器
participant RM as 只读模式设置器
participant DB as 数据库
participant CL as 集群节点
MC->>RM : 设置只读模式(true)
RM->>DB : 启用只读保护
RM->>CL : 检查集群传播
CL-->>RM : 确认同步完成
RM-->>MC : 返回设置结果
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L221-L225)

#### 只读模式保护范围

只读模式会阻止对以下表的写入操作：
- 所有业务数据表（Card、Dashboard、User等）
- 排除审计表、用户会话表
- 允许更新卡片最后使用时间戳

**节源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L47-L65)

### 第二阶段：任务调度器管理

#### 停止调度器

任务调度器的停止是确保迁移稳定性的关键步骤：

```mermaid
flowchart TD
A["开始停止调度器"] --> B["检查集群状态"]
B --> C{"是否为集群环境?"}
C --> |是| D["等待模式传播"]
C --> |否| E["直接停止调度器"]
D --> F["执行stop-scheduler!"]
E --> F
F --> G["验证停止成功"]
G --> H["记录停止时间"]
```

**图表源**
- [impl.clj](file://src/metabase/task/impl.clj#L140-L150)

#### 调度器启动恢复

迁移完成后，需要重新启动任务调度器：

```mermaid
sequenceDiagram
participant MC as 迁移控制器
participant TS as 任务调度器
participant DB as 数据库
MC->>TS : set-jdbc-backend-properties!
MC->>TS : 启动调度器
TS->>DB : 连接新数据库
DB-->>TS : 确认连接
TS-->>MC : 启动完成
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L246-L248)

### 第三阶段：H2数据库备份生成

#### dump_to_h2功能调用

H2数据库备份的核心功能通过`dump-to-h2`命令实现：

```mermaid
flowchart TD
A["调用dump-to-h2!"] --> B["创建H2数据源"]
B --> C["删除现有文件"]
C --> D["执行数据复制"]
D --> E{"需要明文备份?"}
E --> |是| F["旋转加密密钥"]
E --> |否| G["执行CHECKPOINT SYNC"]
F --> G
G --> H["刷新到磁盘"]
H --> I["备份完成"]
```

**图表源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L36-L46)

#### 参数配置详解

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| h2-filename | String | "metabase_dump.h2" | H2文件名 |
| keep-existing? | Boolean | false | 是否保留现有文件 |
| dump-plaintext? | Boolean | false | 是否生成明文备份 |

**节源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L25-L35)

### 第四阶段：安全上传机制

#### 单文件上传

对于小于100MB的文件，使用单文件上传：

```mermaid
sequenceDiagram
participant MC as 迁移控制器
participant SU as 存储上传器
participant SS as 存储服务
MC->>SU : 单文件上传请求
SU->>SS : PUT请求(SSE加密)
SS-->>SU : 返回ETag
SU-->>MC : 上传完成
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L158-L160)

#### 多部分上传

对于大于100MB的文件，采用多部分上传机制：

```mermaid
flowchart TD
A["检测文件大小"] --> B{"大于100MB?"}
B --> |否| C["单文件上传"]
B --> |是| D["计算分块"]
D --> E["获取上传URL"]
E --> F["并行上传分块"]
F --> G["收集ETag"]
G --> H["完成多部分上传"]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L161-L196)

#### 上传进度监控

```mermaid
graph LR
A[文件流] --> B[进度计算]
B --> C[百分比回调]
C --> D[状态更新]
D --> E[集群同步]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L115-L125)

## 任务调度器管理

### 调度器生命周期

任务调度器在迁移过程中的生命周期管理：

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 待机模式
待机模式 --> 运行中 : start-scheduler!
运行中 --> 待机模式 : stop-scheduler!
待机模式 --> [*] : 关闭
```

**图表源**
- [impl.clj](file://src/metabase/task/impl.clj#L120-L150)

### 调度器配置管理

调度器的配置信息通过以下方式管理：

| 配置项 | 作用 | 影响范围 |
|--------|------|----------|
| JDBC后端属性 | 数据库连接配置 | 所有定时任务 |
| 触发器状态 | 任务执行计划 | 定时任务调度 |
| 作业监听器 | 任务执行监控 | 任务状态跟踪 |

**节源**
- [impl.clj](file://src/metabase/task/impl.clj#L80-L90)

## H2数据库备份处理

### 备份生成流程

H2数据库备份的完整生成流程：

```mermaid
sequenceDiagram
participant CMD as 命令行
participant DUMP as dump-to-h2
participant DB as 应用数据库
participant H2 as H2文件
CMD->>DUMP : 调用dump-to-h2!
DUMP->>DB : 获取数据源
DUMP->>H2 : 创建H2数据源
DUMP->>H2 : 删除现有文件
DUMP->>DB : 执行数据复制
DB-->>DUMP : 复制完成
DUMP->>H2 : 执行CHECKPOINT SYNC
H2-->>DUMP : 刷新完成
DUMP-->>CMD : 备份就绪
```

**图表源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L36-L46)

### 加密处理

备份文件的加密处理机制：

```mermaid
flowchart TD
A["备份生成"] --> B{"需要明文?"}
B --> |是| C["旋转加密密钥"]
B --> |否| D["保持加密状态"]
C --> E["清除敏感数据"]
E --> F["CHECKPOINT SYNC"]
D --> F
F --> G["备份完成"]
```

**图表源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L42-L45)

### 文件清理策略

```mermaid
graph TD
A["临时文件"] --> B["UUID命名"]
B --> C["自动清理"]
C --> D["异常处理"]
D --> E["强制删除"]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L258-L260)

## 安全上传机制

### 传输加密

所有上传的数据都采用AWS KMS服务器端加密：

| 加密类型 | 算法 | 密钥长度 | 用途 |
|----------|------|----------|------|
| SSE-KMS | AES-256 | 256位 | 服务器端加密 |
| 传输层 | TLS 1.2+ | 动态 | 网络传输加密 |

### 上传可靠性

```mermaid
flowchart TD
A["上传请求"] --> B["重试机制"]
B --> C{"成功?"}
C --> |是| D["确认完成"]
C --> |否| E["指数退避"]
E --> F["最大重试次数"]
F --> G["失败处理"]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L135-L145)

### 断点续传支持

多部分上传支持断点续传：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Server as 服务器
participant Storage as 存储
Client->>Server : 请求上传会话
Server-->>Client : 返回分块URL
Client->>Storage : 并行上传分块
Storage-->>Client : 返回ETag
Client->>Server : 完成上传
Server-->>Client : 确认成功
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L173-L196)

## 数据一致性保障

### 只读模式验证

```mermaid
flowchart TD
A["设置只读模式"] --> B["验证模式状态"]
B --> C{"模式已启用?"}
C --> |是| D["执行备份"]
C --> |否| E["抛出异常"]
D --> F["验证备份完整性"]
F --> G["恢复模式"]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L227-L230)

### 写入保护机制

只读模式通过管道拦截写入操作：

```mermaid
sequenceDiagram
participant App as 应用程序
participant Pipe as 管道处理器
participant Model as 模型层
participant DB as 数据库
App->>Pipe : 写入请求
Pipe->>Pipe : 检查只读模式
Pipe->>Model : 验证表权限
alt 只读模式且不允许写入
Pipe-->>App : 抛出403异常
else 正常写入
Pipe->>DB : 执行写入
DB-->>Pipe : 返回结果
Pipe-->>App : 返回结果
end
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L70-L85)

### 数据完整性检查

迁移过程中的数据完整性验证：

| 检查项目 | 验证方法 | 失败处理 |
|----------|----------|----------|
| 只读模式状态 | 模式标志检查 | 异常终止 |
| 备份文件完整性 | 文件大小验证 | 重新生成 |
| 上传完成状态 | ETag匹配 | 重新上传 |
| 集群同步状态 | 缓存更新间隔 | 等待同步 |

**节源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L227-L230)

## 验证检查点

### 迁移状态管理

```mermaid
stateDiagram-v2
[*] --> init
init --> setup : 设置只读模式
setup --> dump : 生成备份
dump --> upload : 上传文件
upload --> done : 完成迁移
setup --> error : 设置失败
dump --> error : 备份失败
upload --> error : 上传失败
error --> [*]
done --> [*]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L108-L115)

### 进度跟踪

每个阶段都有详细的进度跟踪：

| 阶段 | 进度范围 | 描述 |
|------|----------|------|
| init | 0% | 初始化状态 |
| setup | 1% | 设置只读模式 |
| dump | 20-49% | H2备份生成 |
| upload | 51-99% | 文件上传 |
| done | 100% | 迁移完成 |

**节源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L122-L125)

### 终止状态处理

```mermaid
flowchart TD
A["迁移执行"] --> B{"检查终端状态"}
B --> |是| C["抛出终端异常"]
B --> |否| D["继续执行"]
C --> E["记录日志"]
D --> F["更新状态"]
F --> G["返回结果"]
```

**图表源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L250-L255)

## 故障排除指南

### 常见问题及解决方案

#### 只读模式设置失败

**症状**: 备份过程中出现写入冲突错误

**原因**: 只读模式未正确设置或集群同步延迟

**解决方案**:
1. 检查集群节点状态
2. 增加等待时间
3. 手动验证只读模式状态

#### 任务调度器停止失败

**症状**: 调度器无法正常停止

**原因**: 任务正在执行或调度器配置错误

**解决方案**:
1. 等待当前任务完成
2. 检查调度器配置
3. 强制关闭调度器

#### 备份文件损坏

**症状**: H2文件无法正常加载

**原因**: 写入操作干扰或磁盘空间不足

**解决方案**:
1. 重新生成备份文件
2. 检查磁盘空间
3. 验证文件完整性

#### 上传超时

**症状**: 文件上传过程中断

**原因**: 网络不稳定或文件过大

**解决方案**:
1. 使用多部分上传
2. 增加重试次数
3. 检查网络连接

### 日志分析

关键日志位置和含义：

| 日志级别 | 关键词 | 含义 |
|----------|--------|------|
| INFO | "Setting read-only mode" | 只读模式设置 |
| INFO | "Stopping scheduler" | 调度器停止 |
| INFO | "Dumping h2 backup" | 备份生成 |
| INFO | "Uploading dump" | 文件上传 |
| ERROR | "Migration failed" | 迁移失败 |

**节源**
- [cloud_migration.clj](file://src/metabase/cloud_migration/models/cloud_migration.clj#L220-L255)

## 最佳实践建议

### 迁移前准备清单

- [ ] 验证系统资源充足
- [ ] 备份当前配置文件
- [ ] 测试网络连接
- [ ] 确认存储权限
- [ ] 准备回滚方案

### 迁移过程监控

- 实时监控迁移进度
- 定期检查系统状态
- 记录关键操作时间
- 监控资源使用情况

### 迁移后验证

- 验证数据完整性
- 测试核心功能
- 检查性能指标
- 更新监控告警

### 安全考虑

- 使用HTTPS传输
- 启用服务器端加密
- 定期轮换访问密钥
- 监控异常访问

通过遵循本指南中的步骤和最佳实践，可以确保Metabase从本地实例到云环境的平滑迁移，最大程度地减少服务中断和数据丢失风险。