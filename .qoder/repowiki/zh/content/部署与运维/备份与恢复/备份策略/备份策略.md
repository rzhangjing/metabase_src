# Metabase备份策略文档

<cite>
**本文档中引用的文件**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj)
- [copy.clj](file://src/metabase/cmd/copy.clj)
- [copy/h2.clj](file://src/metabase/cmd/copy/h2.clj)
- [load_from_h2.clj](file://src/metabase/cmd/load_from_h2.clj)
- [custom_migrations.clj](file://src/metabase/app_db/custom_migrations.clj)
- [encryption.clj](file://src/metabase/app_db/encryption.clj)
- [connection.clj](file://src/metabase/app_db/connection.clj)
- [json_migration.clj](file://src/metabase/models/json_migration.clj)
- [update_h2.clj](file://src/metabase/app_db/update_h2.clj)
- [h2.clj](file://src/metabase/driver/h2.clj)
</cite>

## 目录
1. [概述](#概述)
2. [dump-to-h2命令详解](#dump-to-h2命令详解)
3. [备份过程架构](#备份过程架构)
4. [数据复制机制](#数据复制机制)
5. [加密数据处理](#加密数据处理)
6. [数据一致性保障](#数据一致性保障)
7. [CHECKPOINT SYNC机制](#checkpoint-sync机制)
8. [生产环境最佳实践](#生产环境最佳实践)
9. [故障排除指南](#故障排除指南)
10. [总结](#总结)

## 概述

Metabase提供了基于H2数据库的备份策略，主要通过`dump-to-h2`命令实现从现有应用数据库到H2文件的完整数据导出。该备份机制采用事务性数据复制、加密字段特殊处理和数据一致性保障等关键技术，确保备份过程的安全性和可靠性。

## dump-to-h2命令详解

### 命令结构与参数

`dump-to-h2`命令是Metabase备份系统的核心组件，负责将应用数据库中的所有数据导出到H2文件格式。

```mermaid
flowchart TD
A["启动dump-to-h2命令"] --> B["解析命令参数"]
B --> C{"检查keep-existing?参数"}
C --> |false| D["删除现有H2文件"]
C --> |true| E["保留现有H2文件"]
D --> F["建立源数据库连接"]
E --> F
F --> G["建立目标H2数据库连接"]
G --> H["执行数据复制"]
H --> I{"检查dump-plaintext?参数"}
I --> |true| J["旋转加密密钥"]
I --> |false| K["跳过加密处理"]
J --> L["执行CHECKPOINT SYNC"]
K --> L
L --> M["备份完成"]
```

**图表来源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L25-L46)

### 关键参数说明

| 参数 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| `h2-filename` | 字符串 | "metabase_dump.h2" | 目标H2数据库文件路径 |
| `keep-existing?` | 布尔值 | false | 是否保留已存在的H2文件 |
| `dump-plaintext?` | 布尔值 | false | 是否以明文形式导出数据 |

**节来源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L25-L46)

## 备份过程架构

### 整体架构设计

```mermaid
graph TB
subgraph "源数据库层"
A[应用数据库<br/>PostgreSQL/MySQL/H2]
B[连接池管理]
C[事务控制]
end
subgraph "备份处理层"
D[dump-to-h2命令]
E[数据验证]
F[实体排序]
G[批量处理]
end
subgraph "目标存储层"
H[H2数据库文件]
I[CHECKPOINT SYNC]
J[数据持久化]
end
A --> B
B --> C
C --> D
D --> E
E --> F
F --> G
G --> H
H --> I
I --> J
```

**图表来源**
- [copy.clj](file://src/metabase/cmd/copy.clj#L45-L85)
- [connection.clj](file://src/metabase/app_db/connection.clj#L40-L80)

### 实体依赖关系

备份过程按照严格的实体依赖顺序进行数据复制，确保外键约束的一致性：

```mermaid
graph LR
A[Channel] --> B[Database]
B --> C[User]
C --> D[Setting]
D --> E[Table]
E --> F[Field]
F --> G[FieldValues]
G --> H[Segment]
H --> I[Revision]
I --> J[Dashboard]
J --> K[Card]
K --> L[Pulse]
L --> M[Permissions]
M --> N[Collection]
N --> O[Bookmark]
O --> P[Notification]
```

**图表来源**
- [copy.clj](file://src/metabase/cmd/copy.clj#L50-L85)

**节来源**
- [copy.clj](file://src/metabase/cmd/copy.clj#L50-L85)

## 数据复制机制

### 连接管理与事务控制

Metabase采用多层连接管理和事务控制机制确保数据复制的可靠性：

```mermaid
sequenceDiagram
participant CLI as 命令行接口
participant DM as dump-to-h2模块
participant CM as copy模块
participant SM as 子系统管理器
participant DB as H2数据库
CLI->>DM : 执行dump-to-h2命令
DM->>SM : 获取源数据库连接
SM-->>DM : 返回DataSource
DM->>SM : 获取目标H2数据库连接
SM-->>DM : 返回H2 DataSource
DM->>CM : 调用copy!函数
CM->>CM : 禁用外键约束
CM->>CM : 开始事务
loop 遍历实体
CM->>SM : 查询源数据
SM-->>CM : 返回数据集
CM->>CM : 批量插入目标
end
CM->>CM : 提交事务
CM-->>DM : 复制完成
DM->>DB : 执行CHECKPOINT SYNC
DB-->>DM : 确认持久化
DM-->>CLI : 备份成功
```

**图表来源**
- [copy.clj](file://src/metabase/cmd/copy.clj#L439-L448)
- [connection.clj](file://src/metabase/app_db/connection.clj#L125-L164)

### 数据复制流程

数据复制过程采用分块处理和批量插入优化：

| 步骤 | 操作 | 性能特点 |
|------|------|----------|
| 1 | 禁用外键约束 | 避免插入顺序限制 |
| 2 | 开启事务模式 | 确保原子性 |
| 3 | 分块读取数据 | 控制内存使用 |
| 4 | 批量插入目标 | 提高写入效率 |
| 5 | 提交事务 | 确保数据完整性 |

**节来源**
- [copy.clj](file://src/metabase/cmd/copy.clj#L242-L272)
- [copy.clj](file://src/metabase/cmd/copy.clj#L299-L333)

## 加密数据处理

### 加密字段识别与处理

Metabase对加密字段采用特殊的处理机制，确保备份数据的安全性：

```mermaid
flowchart TD
A[读取数据库记录] --> B{检查字段类型}
B --> |加密字符串| C[识别为可能加密数据]
B --> |普通字符串| D[直接处理]
B --> |JSON对象| E[递归检查子字段]
C --> F{尝试解密}
F --> |解密成功| G[处理解密后数据]
F --> |解密失败| H[标记为加密状态]
E --> I{子字段是否加密}
I --> |是| J[递归解密]
I --> |否| K[保持原样]
G --> L[序列化为JSON]
H --> M[保留原始加密格式]
J --> L
K --> L
D --> L
M --> L
L --> N[写入H2文件]
```

**图表来源**
- [encryption.clj](file://src/metabase/app_db/encryption.clj#L10-L60)
- [custom_migrations.clj](file://src/metabase/app_db/custom_migrations.clj#L115-L142)

### 加密处理函数

| 函数名 | 功能 | 应用场景 |
|--------|------|----------|
| `encrypted-json-in` | 加密JSON输入 | 写入数据库前的加密 |
| `encrypted-json-out` | 解密JSON输出 | 读取数据库后的解密 |
| `maybe-encrypt` | 条件加密 | 根据配置决定是否加密 |
| `maybe-decrypt` | 条件解密 | 根据配置决定是否解密 |

**节来源**
- [encryption.clj](file://src/metabase/app_db/encryption.clj#L10-L60)
- [custom_migrations.clj](file://src/metabase/app_db/custom_migrations.clj#L115-L142)

## 数据一致性保障

### 事务管理机制

Metabase实现了多层次的事务管理确保数据一致性：

```mermaid
graph TB
subgraph "事务层次结构"
A[顶级事务] --> B[嵌套事务1]
A --> C[嵌套事务2]
B --> D[子事务1]
B --> E[子事务2]
C --> F[子事务3]
end
subgraph "保存点机制"
G[设置保存点] --> H[执行操作]
H --> I{操作成功?}
I --> |是| J[提交当前层级]
I --> |否| K[回滚到保存点]
K --> L[继续下一层级]
J --> M[逐层提交]
end
A --> G
D --> G
E --> G
F --> G
```

**图表来源**
- [connection.clj](file://src/metabase/app_db/connection.clj#L140-L180)

### 自定义迁移中的数据一致性

自定义迁移通过可逆机制确保数据一致性：

| 特性 | 实现方式 | 优势 |
|------|----------|------|
| 可逆性 | 定义正向和反向迁移 | 支持版本回退 |
| 事务保护 | 包装在数据库事务中 | 确保原子性 |
| 错误处理 | 异常捕获和回滚 | 防止部分更新 |
| 状态跟踪 | 使用`should-execute-change?` | 避免重复执行 |

**节来源**
- [custom_migrations.clj](file://src/metabase/app_db/custom_migrations.clj#L61-L99)

## CHECKPOINT SYNC机制

### 数据持久化保证

`CHECKPOINT SYNC`是H2数据库的关键操作，确保内存中的数据完全持久化到磁盘：

```mermaid
sequenceDiagram
participant App as 应用程序
participant H2 as H2数据库
participant Disk as 磁盘存储
App->>H2 : 执行数据修改
H2->>H2 : 将数据写入内存缓冲区
App->>H2 : 执行CHECKPOINT SYNC
H2->>H2 : 刷新内存缓冲区
H2->>Disk : 将数据写入磁盘文件
H2->>Disk : 同步文件系统缓存
Disk-->>H2 : 确认写入完成
H2-->>App : 返回确认信息
```

**图表来源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L46)

### CHECKPOINT SYNC的作用

| 功能 | 描述 | 重要性 |
|------|------|--------|
| 内存同步 | 将内存中的脏页写入磁盘 | 防止数据丢失 |
| 文件完整性 | 确保数据文件的完整性 | 避免损坏 |
| 性能优化 | 减少后续I/O操作 | 提高系统性能 |
| 一致性保证 | 确保数据的一致性状态 | 支持恢复操作 |

**节来源**
- [dump_to_h2.clj](file://src/metabase/cmd/dump_to_h2.clj#L46)

## 生产环境最佳实践

### 备份频率策略

根据数据变化频率制定备份计划：

| 数据类型 | 推荐频率 | 备注 |
|----------|----------|------|
| 用户信息 | 每日备份 | 包含敏感信息 |
| 查询历史 | 每周备份 | 数据量较大 |
| 设置配置 | 实时备份 | 影响系统运行 |
| 数据模型 | 版本变更时 | 结构化数据 |

### 存储位置选择

```mermaid
graph TB
subgraph "本地存储"
A[SSD硬盘] --> B[高性能备份]
C[HDD硬盘] --> D[大容量存储]
end
subgraph "网络存储"
E[NAS设备] --> F[共享访问]
G[云存储] --> H[异地备份]
end
subgraph "混合策略"
I[本地快速] --> J[定期同步]
J --> K[远程归档]
end
```

### 性能优化策略

| 优化项 | 方法 | 预期效果 |
|--------|------|----------|
| 并行处理 | 批量分片处理 | 提高处理速度 |
| 内存管理 | 控制批大小 | 避免内存溢出 |
| 网络优化 | 压缩传输 | 减少带宽占用 |
| 存储优化 | SSD优先 | 提升I/O性能 |

### 备份验证流程

```mermaid
flowchart TD
A[执行备份] --> B[生成校验和]
B --> C[存储元数据]
C --> D[定期验证]
D --> E{校验通过?}
E --> |是| F[标记为有效]
E --> |否| G[触发告警]
G --> H[尝试修复]
H --> I{修复成功?}
I --> |是| F
I --> |否| J[人工介入]
F --> K[更新监控状态]
```

## 故障排除指南

### 常见问题及解决方案

| 问题类型 | 症状 | 解决方案 |
|----------|------|----------|
| 内存不足 | 备份过程中OOM异常 | 减小批处理大小 |
| 权限错误 | 无法访问数据库 | 检查数据库连接权限 |
| 文件锁定 | H2文件被占用 | 确保数据库服务停止 |
| 加密失败 | 解密字段报错 | 检查加密密钥配置 |

### 监控指标

```mermaid
graph LR
A[备份时间] --> D[性能监控]
B[数据量大小] --> D
C[错误率] --> D
D --> E[告警通知]
E --> F[自动恢复]
```

### 恢复流程

当备份出现问题时的标准恢复流程：

1. **问题诊断**：分析错误日志和系统状态
2. **数据验证**：检查现有备份的完整性
3. **清理工作**：移除损坏的备份文件
4. **重新备份**：执行新的备份操作
5. **验证测试**：确保备份可用性

## 总结

Metabase的基于H2数据库的备份策略通过dump-to-h2命令实现了完整的数据导出功能。该策略具有以下核心优势：

1. **安全性**：支持加密数据的特殊处理和密钥轮换
2. **可靠性**：采用事务性操作和CHECKPOINT SYNC确保数据一致性
3. **灵活性**：支持多种参数配置和自定义迁移
4. **性能**：通过批量处理和连接池优化提升备份效率

通过遵循本文档提供的最佳实践和故障排除指南，可以确保Metabase备份系统的稳定运行和数据安全。建议定期评估备份策略的有效性，并根据业务需求调整备份频率和存储策略。