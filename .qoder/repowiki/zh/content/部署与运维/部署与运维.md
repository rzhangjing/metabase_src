# 部署与运维

<cite>
**本文档中引用的文件**   
- [connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj)
- [cache/settings.clj](file://src/metabase/cache/settings.clj)
- [env.clj](file://src/metabase/app_db/env.clj)
- [core.clj](file://src/metabase/config/core.clj)
- [prometheus.clj](file://src/metabase/analytics/prometheus.clj)
- [logger/core.clj](file://src/metabase/logger/core.clj)
- [setup.clj](file://src/metabase/app_db/setup.clj)
- [cluster_lock.clj](file://src/metabase/app_db/cluster_lock.clj)
</cite>

## 目录
1. [引言](#引言)
2. [环境部署配置](#环境部署配置)
3. [JVM参数调优](#jvm参数调优)
4. [数据库连接池设置](#数据库连接池设置)
5. [缓存策略](#缓存策略)
6. [高可用性部署架构](#高可用性部署架构)
7. [监控和日志记录](#监控和日志记录)
8. [备份和恢复策略](#备份和恢复策略)
9. [升级和迁移指南](#升级和迁移指南)
10. [性能基准测试和优化](#性能基准测试和优化)

## 引言
Metabase是一个开源的数据分析和可视化平台，支持多种数据库连接和复杂的数据查询。本文档详细说明了Metabase在不同环境（开发、测试、生产）下的部署与运维最佳实践，涵盖JVM参数调优、数据库连接池配置、缓存策略、高可用性架构、监控日志、备份恢复以及升级迁移等方面的内容，旨在为系统管理员和运维工程师提供全面的指导。

## 环境部署配置
Metabase支持通过环境变量进行灵活的部署配置，适用于开发、测试和生产等不同环境。核心配置包括数据库连接、应用端口、运行模式等。

### 开发环境
开发环境通常使用H2内存数据库，配置简单，适合快速启动和测试：
- `MB_DB_TYPE=h2`：使用H2数据库
- `MB_DB_FILE=metabase.db`：指定H2数据库文件路径
- `MB_JETTY_PORT=3000`：设置应用端口为3000
- `MB_RUN_MODE=dev`：设置为开发模式

### 生产环境
生产环境推荐使用PostgreSQL或MySQL作为应用数据库，确保数据持久性和高可用性：
- `MB_DB_TYPE=postgres`：使用PostgreSQL作为应用数据库
- `MB_DB_HOST=localhost`：数据库主机地址
- `MB_DB_PORT=5432`：数据库端口
- `MB_DB_USER=metabase`：数据库用户名
- `MB_DB_PASS=password`：数据库密码
- `MB_DB_DBNAME=metabase`：数据库名称

通过JDBC连接字符串配置：
```bash
MB_DB_CONNECTION_URI=jdbc:postgresql://localhost:5432/metabase?user=metabase&password=password
```

### 测试环境
测试环境可以使用与生产环境相同的配置，但数据库可以是独立的测试实例，避免影响生产数据。

**Section sources**
- [env.clj](file://src/metabase/app_db/env.clj#L0-L203)
- [core.clj](file://src/metabase/config/core.clj#L0-L241)

## JVM参数调优
Metabase作为Java应用，其性能与JVM参数配置密切相关。合理的JVM参数设置可以显著提升应用性能和稳定性。

### 基础JVM参数
```bash
java -Xms2g -Xmx4g -XX:MaxMetaspaceSize=512m -jar metabase.jar
```
- `-Xms2g`：初始堆内存大小为2GB
- `-Xmx4g`：最大堆内存大小为4GB
- `-XX:MaxMetaspaceSize=512m`：限制元空间大小，防止内存溢出

### 垃圾回收调优
推荐使用G1垃圾回收器，适用于大内存应用：
```bash
-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:G1HeapRegionSize=16m
```
- `UseG1GC`：启用G1垃圾回收器
- `MaxGCPauseMillis=200`：目标最大GC暂停时间为200毫秒
- `G1HeapRegionSize=16m`：设置G1区域大小为16MB

### JVM监控参数
启用JMX监控，便于性能分析：
```bash
-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false
```

## 数据库连接池设置
Metabase使用c3p0连接池管理数据库连接，合理的连接池配置对系统性能至关重要。

### 连接池核心参数
根据代码分析，Metabase的连接池配置如下：

```clojure
(def ^:private application-db-connection-pool-props
  {"idleConnectionTestPeriod" 60
   "connectionCustomizerClassName" (.getName MetabaseConnectionCustomizer)
   "maxIdleTimeExcessConnections" (* 10 60) ; 10 minutes
   "maxConnectionAge" (* 60 60) ; one hour
   "maxPoolSize" (or (config/config-int :mb-application-db-max-connection-pool-size) 15)})
```

- `idleConnectionTestPeriod=60`：每60秒测试一次空闲连接
- `maxIdleTimeExcessConnections=600`：超过最小池大小的连接在空闲10分钟后被清除
- `maxConnectionAge=3600`：连接最长存活时间为1小时
- `maxPoolSize=15`：最大连接数为15（可通过MB_APPLICATION_DB_MAX_CONNECTION_POOL_SIZE环境变量调整）

### 连接池监控
Metabase通过Prometheus暴露连接池指标，便于监控：
- `c3p0_max_pool_size`：连接池最大大小
- `c3p0_min_pool_size`：连接池最小大小
- `c3p0_num_connections`：当前连接数
- `c3p0_num_idle_connections`：空闲连接数
- `c3p0_num_busy_connections`：繁忙连接数

**Section sources**
- [connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj#L0-L151)
- [prometheus.clj](file://src/metabase/analytics/prometheus.clj#L93-L120)

## 缓存策略
Metabase提供查询结果缓存功能，可以显著提升重复查询的性能。

### 缓存配置
```clojure
(defsetting enable-query-caching
  "Allow caching results of queries that take a long time to run."
  :type       :boolean
  :default    true
  :visibility :authenticated)

(defsetting query-caching-max-kb
  "The maximum size of the cache, per saved question, in kilobytes:"
  :type    :integer
  :default 2000
  :setter  (fn [new-value]
             (when (> (cond-> new-value (string? new-value) parse-long) global-max-caching-kb)
               (throw (IllegalArgumentException. "Values greater than 200MB are not allowed.")))
             (setting/set-value-of-type! :integer :query-caching-max-kb new-value)))

(defsetting query-caching-max-ttl
  "The absolute maximum time to keep any cached query results, in seconds."
  :type    :double
  :default (* 60.0 60.0 24.0 35.0) ; 35 days
  :audit   :getter)
```

- `enable-query-caching`：启用查询缓存，默认为true
- `query-caching-max-kb`：每个查询结果的最大缓存大小，默认2000KB（2MB），最大限制200MB
- `query-caching-max-ttl`：缓存结果的最大存活时间，默认35天

### 缓存后端
Metabase支持多种缓存后端：
- `db`：使用应用数据库存储缓存（默认）
- `redis`：使用Redis作为缓存后端
- `memcached`：使用Memcached作为缓存后端

通过`MB_QP_CACHE_BACKEND`环境变量配置缓存后端。

**Section sources**
- [settings.clj](file://src/metabase/cache/settings.clj#L0-L46)
- [core.clj](file://src/metabase/config/core.clj#L0-L241)

## 高可用性部署架构
为了确保Metabase服务的高可用性，建议采用集群部署模式。

### 负载均衡
使用反向代理服务器（如Nginx、HAProxy）实现负载均衡：
```nginx
upstream metabase {
    server metabase1:3000;
    server metabase2:3000;
    server metabase3:3000;
}

server {
    listen 80;
    location / {
        proxy_pass http://metabase;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 故障转移
- 配置多个Metabase实例，共享同一个应用数据库
- 使用健康检查机制自动检测实例状态
- 当某个实例故障时，负载均衡器自动将流量转移到健康实例

### 数据复制
- 应用数据库（PostgreSQL/MySQL）配置主从复制
- 数据仓库连接配置读写分离
- 使用数据库连接池的故障转移功能

### 集群锁机制
Metabase使用应用数据库实现集群锁，确保集群操作的一致性：
```clojure
(def ^:private cluster-lock-timeout-seconds 1)

(def ^:private default-retry-config
  {:max-attempts 5
   :multiplier 1.0
   :randomization-factor 0.1
   :initial-interval-millis 1000
   :max-interval-millis 1000
   :retry-on-exception-pred retryable?})
```

- `cluster-lock-timeout-seconds=1`：集群锁超时时间为1秒
- 重试配置：最多重试5次，初始间隔1秒

**Section sources**
- [cluster_lock.clj](file://src/metabase/app_db/cluster_lock.clj#L0-L83)
- [env.clj](file://src/metabase/app_db/env.clj#L0-L203)

## 监控和日志记录
完善的监控和日志记录是保障系统稳定运行的关键。

### Prometheus监控
Metabase内置Prometheus监控支持，可通过环境变量启用：
- `MB_PROMETHEUS_SERVER_PORT=9090`：启用Prometheus监控，监听9090端口
- 监控指标包括：JVM指标、连接池指标、查询性能指标等

### 日志配置
Metabase使用Log4j2作为日志框架，支持灵活的日志级别配置：
```clojure
(defn set-ns-log-level!
  "Set the log level for the namespace named by `a-namespace`."
  ([new-level]
   (set-ns-log-level! (ns-name *ns*) new-level))
  ([a-namespace new-level]
   (ensure-unique-logger! a-namespace)
   (let [logger    (exact-ns-logger a-namespace)
         new-level (->Level new-level)]
     (.setLevel logger new-level)
     ;; 更新appender的级别
     (doseq [[^String appender-name ^Appender appender] (.getAppenders logger)]
       (.removeAppender logger appender-name)
       (.addAppender logger appender new-level (.getFilter logger)))
     (.updateLoggers (context)))))
```

支持的日志级别：OFF、FATAL、ERROR、WARN、INFO、DEBUG、TRACE

### 审计日志
启用审计日志记录用户操作：
- `MB_AUDIT_MAX_RETENTION_DAYS`：审计日志保留天数，默认720天
- 最小保留天数为30天

**Section sources**
- [prometheus.clj](file://src/metabase/analytics/prometheus.clj#L0-L667)
- [core.clj](file://src/metabase/logger/core.clj#L0-L279)
- [settings.clj](file://src/metabase/audit_app/settings.clj#L0-L41)

## 备份和恢复策略
数据安全是系统运维的重中之重，必须建立完善的备份和恢复机制。

### 备份策略
#### 应用数据库备份
定期备份Metabase应用数据库：
```bash
# PostgreSQL备份
pg_dump -h localhost -U metabase -d metabase -f metabase_backup.sql

# MySQL备份
mysqldump -h localhost -u metabase -p metabase > metabase_backup.sql
```

#### H2数据库备份
对于H2数据库，使用Metabase内置的备份命令：
```bash
java -jar metabase.jar load-from-h2 --dump-plaintext
```

### 恢复策略
#### 从备份恢复
```bash
# PostgreSQL恢复
psql -h localhost -U metabase -d metabase -f metabase_backup.sql

# MySQL恢复
mysql -h localhost -u metabase -p metabase < metabase_backup.sql
```

#### 灾难恢复
- 保持至少3个备份副本，分别存储在不同位置
- 定期测试恢复流程，确保备份有效性
- 记录详细的恢复步骤和联系人信息

**Section sources**
- [setup.clj](file://src/metabase/app_db/setup.clj#L0-L290)
- [load_from_h2.clj](file://src/metabase/cmd/load_from_h2.clj#L0-L36)

## 升级和迁移指南
Metabase的升级和迁移需要谨慎操作，确保数据完整性和系统稳定性。

### 版本兼容性
- 仔细阅读版本发布说明，了解兼容性变化
- 在测试环境先行测试升级流程
- 备份当前数据库和配置文件

### 数据迁移
#### 从H2迁移到生产数据库
```bash
# 1. 停止Metabase服务
# 2. 备份H2数据库
java -jar metabase.jar dump-to-h2 --dump-plaintext

# 3. 配置目标数据库环境变量
export MB_DB_TYPE=postgres
export MB_DB_HOST=localhost
export MB_DB_PORT=5432
export MB_DB_USER=metabase
export MB_DB_PASS=password
export MB_DB_DBNAME=metabase

# 4. 执行数据迁移
java -jar metabase.jar load-from-h2
```

### 回滚计划
#### 升级失败回滚
1. 停止新版本Metabase服务
2. 恢复备份的数据库
3. 启动旧版本Metabase服务
4. 验证系统功能正常

#### 数据库降级
```bash
# 执行数据库降级
java -jar metabase.jar migrate down
```

**Section sources**
- [setup.clj](file://src/metabase/app_db/setup.clj#L0-L290)
- [copy.clj](file://src/metabase/cmd/copy.clj#L0-L38)

## 性能基准测试和优化
定期进行性能基准测试，识别瓶颈并实施优化措施。

### 基准测试指标
- 查询响应时间：P50、P90、P99
- 系统吞吐量：每秒查询数（QPS）
- 资源利用率：CPU、内存、磁盘I/O
- 并发用户支持能力

### 优化建议
#### 查询优化
- 启用查询缓存，减少重复查询开销
- 优化数据仓库查询，添加适当索引
- 限制查询结果大小，避免大数据集传输

#### JVM优化
- 根据负载调整堆内存大小
- 选择合适的垃圾回收器
- 监控GC暂停时间，确保用户体验

#### 数据库优化
- 定期分析和优化应用数据库
- 调整连接池大小，匹配实际并发需求
- 监控慢查询，及时优化

#### 缓存优化
- 根据查询模式调整缓存策略
- 监控缓存命中率，评估缓存效果
- 合理设置缓存过期时间，平衡数据新鲜度和性能

**Section sources**
- [prometheus.clj](file://src/metabase/analytics/prometheus.clj#L0-L667)
- [connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj#L0-L151)
- [settings.clj](file://src/metabase/cache/settings.clj#L0-L46)