# 核心任务

<cite>
**本文档中引用的文件**  
- [send_anonymous_stats.clj](file://src/metabase/analytics/task/send_anonymous_stats.clj)
- [truncate_audit_tables.clj](file://src/metabase/audit_app/task/truncate_audit_tables.clj)
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj)
- [refresh_slack_channel_user_cache.clj](file://src/metabase/channel/task/refresh_slack_channel_user_cache.clj)
- [send.clj](file://src/metabase/notification/task/send.clj)
- [send_pulses.clj](file://src/metabase/pulse/task/send_pulses.clj)
- [sync_metadata.clj](file://src/metabase/sync/sync_metadata.clj)
- [core.clj](file://src/metabase/task/core.clj)
- [impl.clj](file://src/metabase/task/impl.clj)
- [task_history.clj](file://src/metabase/task_history/models/task_history.clj)
- [api.clj](file://src/metabase/task_history/api.clj)
</cite>

## 目录
1. [引言](#引言)
2. [核心任务概览](#核心任务概览)
3. [任务功能与行为详解](#任务功能与行为详解)
4. [任务定义结构与Cron表达式配置](#任务定义结构与cron表达式配置)
5. [任务间依赖关系与执行优先级](#任务间依赖关系与执行优先级)
6. [任务状态监控与执行历史查看](#任务状态监控与执行历史查看)
7. [资源使用情况分析](#资源使用情况分析)
8. [异常处理与日志记录机制](#异常处理与日志记录机制)
9. [结论](#结论)

## 引言
Metabase内置了一套基于Quartz调度框架的核心定时任务系统，用于自动化执行各类系统级维护和业务功能。这些任务涵盖了从匿名统计发送、审计日志清理到脉冲报告推送和持久化模型刷新等关键操作。本文档旨在提供一个全面的参考，详细说明这些核心任务的功能、行为、配置方式以及监控机制，帮助开发者和系统管理员深入理解Metabase后台任务的运作原理。

**Section sources**
- [impl.clj](file://src/metabase/task/impl.clj#L0-L377)

## 核心任务概览
Metabase的核心任务主要分为以下几类：
- **分析与统计任务**：如匿名使用统计的发送。
- **通知与推送任务**：如脉冲报告（Pulse）和通知（Notification）的定时发送。
- **数据维护任务**：如审计日志表的清理和持久化模型的刷新。
- **元数据同步任务**：如数据库元数据的定期同步。
- **缓存管理任务**：如Slack频道和用户缓存的刷新。

这些任务通过Quartz调度器统一管理，确保在指定的时间点或周期内可靠执行。

**Section sources**
- [send_anonymous_stats.clj](file://src/metabase/analytics/task/send_anonymous_stats.clj#L0-L40)
- [send_pulses.clj](file://src/metabase/pulse/task/send_pulses.clj#L0-L268)
- [truncate_audit_tables.clj](file://src/metabase/audit_app/task/truncate_audit_tables.clj#L0-L92)
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj#L0-L446)
- [sync_metadata.clj](file://src/metabase/sync/sync_metadata.clj#L0-L78)

## 任务功能与行为详解

### 匿名统计发送任务
此任务负责定期向Metabase团队发送匿名的使用统计信息，以帮助改进产品。任务的执行逻辑如下：
1. 检查匿名跟踪功能是否启用。
2. 如果启用，则调用`phone-home-stats!`函数收集并发送数据。
3. 任务执行过程中会捕获任何异常并记录错误日志。

该任务对于了解产品使用情况至关重要，但完全可选，用户可以在设置中禁用。

**Section sources**
- [send_anonymous_stats.clj](file://src/metabase/analytics/task/send_anonymous_stats.clj#L0-L40)

### 脉冲报告推送任务
此任务负责根据预设的时间表，将脉冲报告（Pulse）推送到配置的渠道（如邮件、Slack）。其核心行为包括：
1. 为每个需要推送的脉冲创建一个Quartz触发器。
2. 触发器在指定时间触发，执行`send-pulse!`函数。
3. 函数会检索脉冲的详细信息，并通过相应的渠道发送报告。
4. 支持在报告时区变更时自动更新所有触发器的时区。

此任务确保了用户能够按时收到关键的业务洞察。

**Section sources**
- [send_pulses.clj](file://src/metabase/pulse/task/send_pulses.clj#L0-L268)

### 审计日志清理任务
此任务用于管理审计相关表（如`audit_log`, `view_log`, `query_execution`）的数据量，防止数据库过度膨胀。其执行逻辑为：
1. 根据配置的保留天数（`audit-max-retention-days`）确定清理阈值。
2. 分批删除超过保留期限的旧记录，以避免长时间锁定表。
3. 记录清理的行数，便于监控。

该任务是数据库维护的关键部分，有助于保持系统性能和存储效率。

**Section sources**
- [truncate_audit_tables.clj](file://src/metabase/audit_app/task/truncate_audit_tables.clj#L0-L92)

### 持久化模型刷新任务
此任务负责刷新持久化模型（Persisted Models），以确保缓存的数据保持最新。其行为分为两个子任务：
1. **刷新任务**：遍历所有标记为“可刷新”的持久化模型，执行其底层查询以更新缓存表。
2. **清理任务**：删除所有标记为“可删除”的持久化模型及其对应的缓存表。

任务执行时会更新`PersistedInfo`表中的状态（如`refreshing`, `persisted`, `error`），并记录开始和结束时间。

**Section sources**
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj#L0-L446)

## 任务定义结构与Cron表达式配置

### 任务定义结构
Metabase中的任务通常遵循一个标准的Clojure命名空间结构：
1. **命名空间声明**：以`ns metabase.<module>.task.<task-name>`开头。
2. **任务定义**：使用`task/defjob`宏定义一个作业类，其中包含任务的执行逻辑。
3. **初始化方法**：实现`task/init!`多态方法，用于在系统启动时注册和调度任务。
4. **调度配置**：在`init!`方法中，通过`jobs/build`和`triggers/build`构建作业和触发器，并使用`task/schedule-task!`进行调度。

```clojure
(task/defjob ^{:doc "任务描述"} TaskName [_]
  (任务执行逻辑))

(defmethod task/init! ::TaskName [_]
  (let [job (jobs/build ...), trigger (triggers/build ...)]
    (task/schedule-task! job trigger)))
```

**Section sources**
- [send_anonymous_stats.clj](file://src/metabase/analytics/task/send_anonymous_stats.clj#L0-L40)
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj#L0-L446)

### Cron表达式配置
Cron表达式用于定义任务的触发周期。Metabase中的Cron配置具有以下特点：
- **动态生成**：某些任务的Cron表达式在运行时动态生成，例如匿名统计任务会在0-23小时和0-59分钟内随机选择一个时间点，以避免所有实例同时发送请求。
- **时区支持**：任务支持在特定时区执行，通过`cron/in-time-zone`指定，通常使用数据库的报告时区或系统时区。
- **错误处理策略**：通过`cron/with-misfire-handling-instruction-do-nothing`等指令配置任务错过触发时的行为。

例如，审计日志清理任务的Cron表达式为`0 0 */12 * * ? *`，表示每12小时执行一次。

**Section sources**
- [send_anonymous_stats.clj](file://src/metabase/analytics/task/send_anonymous_stats.clj#L25-L28)
- [truncate_audit_tables.clj](file://src/metabase/audit_app/task/truncate_audit_tables.clj#L88-L89)
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj#L278-L284)

## 任务间依赖关系与执行优先级

### 依赖关系
Metabase的任务之间存在明确的依赖关系，主要体现在初始化顺序上：
- **核心调度器初始化**：`task/init-scheduler!`必须在任何任务调度之前完成。
- **任务初始化**：所有任务的`init!`方法在调度器启动后被调用。
- **特定任务依赖**：例如，`InitSendPulseTriggers`任务必须在`SendPulse`作业注册后才能被调度，因为它依赖于`send-pulse-job-key`。

这种依赖通过代码的调用顺序来保证，而不是通过Quartz的触发器依赖。

### 执行优先级
任务的执行优先级通过Quartz触发器的`priority`属性来控制。例如，在`send_pulses.clj`中，触发器的优先级被设置为6，高于同步任务的优先级，确保关键的通知能够优先发送。

**Section sources**
- [impl.clj](file://src/metabase/task/impl.clj#L0-L377)
- [send_pulses.clj](file://src/metabase/pulse/task/send_pulses.clj#L178-L182)

## 任务状态监控与执行历史查看

### 任务状态监控
可以通过调用`task/scheduler-info`函数来获取调度器的实时状态，包括所有作业和触发器的详细信息，如：
- 作业的类名、描述和状态。
- 触发器的下次触发时间、上次触发时间和当前状态（WAITING, EXECUTING, ERROR等）。

这为系统管理员提供了全局的监控视图。

### 执行历史查看
Metabase提供了`TaskHistory`模型来记录任务的执行历史。相关信息可以通过以下方式访问：
1. **API端点**：`/api/task`提供了查询任务历史的REST API。
2. **数据模型**：`task_history`数据库表存储了每次任务执行的开始时间、结束时间、状态和详细信息。
3. **清理机制**：`cleanup-task-history!`函数会定期清理过旧的历史记录，以控制表的大小。

用户可以通过管理界面或直接查询数据库来查看任务的执行历史，这对于故障排查和性能分析非常有用。

**Section sources**
- [api.clj](file://src/metabase/task_history/api.clj#L0-L41)
- [task_history.clj](file://src/metabase/task_history/models/task_history.clj#L0-L185)

## 资源使用情况分析
核心任务的资源使用情况主要受以下因素影响：
- **执行频率**：高频任务（如每小时执行）会比低频任务（如每天执行）消耗更多的CPU和I/O资源。
- **数据量**：清理或刷新任务处理的数据量越大，执行时间和内存消耗也越高。
- **并发控制**：通过`org.quartz.DisallowConcurrentExecution`注解可以防止同一任务的多个实例并发执行，避免资源竞争。

例如，持久化模型刷新任务是一个资源密集型操作，因为它需要执行复杂的查询并写入大量数据。因此，建议在业务低峰期执行此类任务。

**Section sources**
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj#L104-L105)
- [task_history.clj](file://src/metabase/task_history/models/task_history.clj#L32-L53)

## 异常处理与日志记录机制
Metabase的任务系统内置了完善的异常处理和日志记录机制：
- **异常捕获**：每个任务的执行逻辑都包裹在`try-catch`块中，确保任何未处理的异常都不会导致调度器崩溃。
- **日志记录**：使用`metabase.util.log`模块进行结构化日志记录，记录任务的开始、成功、失败和错误详情。
- **错误传播**：对于需要重试的任务，可以使用`rerun-on-error`宏，它会抛出一个`JobExecutionException`，指示Quartz在下次触发时重试。

此外，`task-history`模块还提供了`with-task-history`宏，它能自动记录任务的执行上下文，并在任务失败时捕获异常堆栈，极大地简化了错误追踪。

**Section sources**
- [send_anonymous_stats.clj](file://src/metabase/analytics/task/send_anonymous_stats.clj#L15-L20)
- [persist_refresh.clj](file://src/metabase/model_persistence/task/persist_refresh.clj#L104-L115)
- [task_history.clj](file://src/metabase/task_history/models/task_history.clj#L163-L185)

## 结论
Metabase的内置核心定时任务系统是一个强大而灵活的基础设施，它通过Quartz调度框架实现了对各种系统级任务的自动化管理。通过对任务的触发周期、执行逻辑、异常处理和监控机制的深入理解，开发者和管理员可以更好地维护和优化Metabase实例的性能与稳定性。本文档提供的参考信息，为理解和定制这些核心任务提供了坚实的基础。