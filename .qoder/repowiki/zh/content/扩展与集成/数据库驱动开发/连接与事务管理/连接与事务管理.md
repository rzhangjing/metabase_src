# 连接与事务管理

<cite>
**本文档中引用的文件**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj)
- [app_db/connection.clj](file://src/metabase/app_db/connection.clj)
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj)
- [util/connection.clj](file://src/metabase/util/connection.clj)
- [driver/sql_jdbc/connection/ssh_tunnel.clj](file://src/metabase/driver/sql_jdbc/connection/ssh_tunnel.clj)
- [app_db/connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj)
- [driver/sql_jdbc/common.clj](file://src/metabase/driver/sql_jdbc/common.clj)
- [driver/settings.clj](file://src/metabase/driver/settings.clj)
- [analytics/prometheus.clj](file://src/metabase/analytics/prometheus.clj)
</cite>

## 目录
1. [概述](#概述)
2. [连接池架构](#连接池架构)
3. [SSH隧道支持](#ssh隧道支持)
4. [连接生命周期管理](#连接生命周期管理)
5. [查询执行管道](#查询执行管道)
6. [事务管理](#事务管理)
7. [错误恢复机制](#错误恢复机制)
8. [性能监控与诊断](#性能监控与诊断)
9. [连接泄漏检测](#连接泄漏检测)
10. [最佳实践指南](#最佳实践指南)

## 概述

Metabase的连接与事务管理系统是一个复杂而精密的架构，负责管理应用程序数据库和外部数据源之间的连接。该系统基于C3P0连接池实现，提供了强大的连接池管理、SSH隧道支持、事务控制和错误恢复功能。

### 核心组件概览

```mermaid
graph TB
subgraph "连接管理层"
A[连接池管理器] --> B[C3P0连接池]
A --> C[SSH隧道管理]
A --> D[连接生命周期]
end
subgraph "执行层"
E[查询执行管道] --> F[参数设置]
E --> G[结果处理]
E --> H[事务控制]
end
subgraph "监控层"
I[性能监控] --> J[JMX指标]
I --> K[连接统计]
I --> L[泄漏检测]
end
A --> E
E --> I
```

**图表来源**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L1-L50)
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L1-L50)

## 连接池架构

### C3P0连接池配置

Metabase使用C3P0作为主要的连接池实现，为应用程序数据库和数据仓库提供高效的连接管理。

#### 应用程序数据库连接池

应用程序数据库连接池采用专门的配置策略：

```mermaid
classDiagram
class ApplicationDB {
+Keyword db-type
+DataSource data-source
+Atom status
+Integer id
+ReentrantReadWriteLock lock
+getConnection() Connection
+getConnection(user, password) Connection
}
class ConnectionPoolConfig {
+Integer maxPoolSize
+Integer idleConnectionTestPeriod
+String connectionCustomizerClassName
+Integer maxIdleTimeExcessConnections
+Integer maxConnectionAge
}
class ConnectionCustomizer {
+onAcquire(connection)
+onCheckIn(connection)
+onCheckOut(connection)
+onDestroy(connection)
}
ApplicationDB --> ConnectionPoolConfig
ConnectionPoolConfig --> ConnectionCustomizer
```

**图表来源**
- [app_db/connection.clj](file://src/metabase/app_db/connection.clj#L20-L60)
- [app_db/connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj#L80-L120)

#### 数据仓库连接池配置

数据仓库连接池针对大数据量查询进行了优化：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `acquireIncrement` | 1 | 每次获取连接的数量 |
| `maxPoolSize` | 动态计算 | 最大连接数，受环境变量控制 |
| `minPoolSize` | 0 | 最小空闲连接数 |
| `maxIdleTime` | 3小时 | 连接最大空闲时间 |
| `testConnectionOnCheckout` | true | 检查连接有效性 |
| `unreturnedConnectionTimeout` | 查询超时 | 连接未返回超时时间 |

**节来源**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L60-L130)

### 连接池生命周期管理

连接池的创建、维护和销毁遵循严格的生命周期管理：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Manager as 连接池管理器
participant Pool as C3P0连接池
participant DB as 数据库
Client->>Manager : 请求连接
Manager->>Manager : 检查现有池
alt 池不存在
Manager->>Pool : 创建新连接池
Pool->>DB : 建立连接
DB-->>Pool : 连接就绪
Pool-->>Manager : 池创建完成
end
Manager->>Pool : 获取连接
Pool-->>Manager : 返回连接
Manager-->>Client : 提供连接
Note over Client,DB : 连接使用完毕后自动归还
```

**图表来源**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L200-L250)

## SSH隧道支持

### 隧道建立流程

SSH隧道为通过防火墙访问远程数据库提供了安全通道：

```mermaid
flowchart TD
A[检查SSH隧道配置] --> B{隧道启用?}
B --> |否| C[直接连接数据库]
B --> |是| D[建立SSH连接]
D --> E[认证用户凭据]
E --> F[配置心跳机制]
F --> G[创建端口转发]
G --> H[动态分配入口端口]
H --> I[更新连接详情]
I --> J[返回带隧道的连接]
J --> K[执行数据库操作]
K --> L[关闭隧道]
```

**图表来源**
- [driver/sql_jdbc/connection/ssh_tunnel.clj](file://src/metabase/driver/sql_jdbc/connection/ssh_tunnel.clj#L60-L100)

### 隧道配置参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `tunnel-host` | String | 必需 | SSH服务器主机名 |
| `tunnel-port` | Integer | 22 | SSH服务器端口 |
| `tunnel-user` | String | 必需 | SSH用户名 |
| `tunnel-pass` | String | 可选 | SSH密码 |
| `tunnel-private-key` | String | 可选 | 私钥内容 |
| `heartbeat-interval` | Integer | 180秒 | 心跳间隔 |

**节来源**
- [driver/sql_jdbc/connection/ssh_tunnel.clj](file://src/metabase/driver/sql_jdbc/connection/ssh_tunnel.clj#L20-L40)

## 连接生命周期管理

### 连接状态管理

每个连接都经历明确的状态转换：

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 已连接 : 建立连接
已连接 --> 空闲 : 归还连接
空闲 --> 使用中 : 获取连接
使用中 --> 空闲 : 归还连接
使用中 --> 错误 : 连接异常
空闲 --> 销毁 : 超时或池关闭
错误 --> 销毁 : 重试失败
销毁 --> [*]
```

### 连接验证机制

系统实现了多层次的连接验证：

1. **连接池级验证**：C3P0定期测试连接有效性
2. **连接级验证**：每次获取连接时验证
3. **查询级验证**：关键查询前进行连接测试

**节来源**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L110-L130)

## 查询执行管道

### 执行流程架构

查询执行管道提供了完整的查询处理链路：

```mermaid
flowchart LR
A[查询请求] --> B[连接获取]
B --> C[参数设置]
C --> D[语句准备]
D --> E[查询执行]
E --> F[结果集处理]
F --> G[连接归还]
subgraph "中间件层"
H[超时控制]
I[错误处理]
J[性能监控]
end
B -.-> H
E -.-> I
F -.-> J
```

**图表来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L400-L500)

### 参数绑定与类型转换

系统支持自动类型转换和参数绑定：

| 数据类型 | JDBC类型 | 处理方式 |
|----------|----------|----------|
| LocalDate | Types.DATE | 直接设置 |
| LocalTime | Types.TIME | 直接设置 |
| LocalDateTime | Types.TIMESTAMP | 直接设置 |
| OffsetDateTime | Types.TIMESTAMP_WITH_TIMEZONE | 直接设置 |
| ZonedDateTime | Types.TIMESTAMP_WITH_TIMEZONE | 转换为OffsetDateTime |

**节来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L450-L500)

### 结果集处理

结果集处理采用流式处理模式，支持大数据量查询：

```mermaid
sequenceDiagram
participant Query as 查询处理器
participant ResultSet as 结果集
participant Reader as 列读取器
participant Consumer as 数据消费者
Query->>ResultSet : 执行查询
ResultSet-->>Query : 返回结果集
Query->>Reader : 创建列读取器
loop 处理每一行
Reader->>ResultSet : 获取下一行
ResultSet-->>Reader : 行数据
Reader->>Consumer : 处理列数据
Consumer-->>Reader : 处理完成
end
```

**图表来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L700-L750)

## 事务管理

### 事务隔离级别控制

系统根据数据库特性自动选择最优的事务隔离级别：

```mermaid
flowchart TD
A[获取数据库元数据] --> B[检查支持的隔离级别]
B --> C{支持读未提交?}
C --> |是| D[设置为读未提交]
C --> |否| E{支持读已提交?}
E --> |是| F[设置为读已提交]
E --> |否| G{支持可重复读?}
G --> |是| H[设置为可重复读]
G --> |否| I[使用默认级别]
D --> J[应用到连接]
F --> J
H --> J
I --> J
```

**图表来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L350-L380)

### 嵌套事务支持

系统支持嵌套事务，使用Savepoint实现：

```mermaid
sequenceDiagram
participant Outer as 外层事务
participant Inner as 内层事务
participant Savepoint as 保存点
participant DB as 数据库
Outer->>DB : 开始事务
Outer->>Inner : 启动内层事务
Inner->>Savepoint : 设置保存点
Inner->>DB : 执行操作
DB-->>Inner : 操作成功
Inner->>Savepoint : 回滚到保存点
Inner-->>Outer : 内层事务完成
Outer->>DB : 提交外层事务
DB-->>Outer : 事务提交
```

**图表来源**
- [app_db/connection.clj](file://src/metabase/app_db/connection.clj#L150-L200)

### 事务规则配置

| 规则类型 | 值 | 说明 |
|----------|-----|------|
| `:allow` | 允许嵌套事务 | 正常行为 |
| `:ignore` | 忽略内层事务 | 内层事务不生效 |
| `:prohibit` | 禁止嵌套事务 | 抛出异常 |

**节来源**
- [app_db/connection.clj](file://src/metabase/app_db/connection.clj#L180-L210)

## 错误恢复机制

### 连接故障检测

系统实现了多层连接故障检测机制：

```mermaid
flowchart TD
A[连接请求] --> B[连接池获取]
B --> C{连接可用?}
C --> |是| D[返回连接]
C --> |否| E[检查连接池状态]
E --> F{池已满?}
F --> |是| G[等待可用连接]
F --> |否| H[创建新连接]
H --> I[连接测试]
I --> J{测试成功?}
J --> |是| K[加入池中]
J --> |否| L[标记连接失败]
K --> D
L --> M[抛出异常]
G --> N{超时?}
N --> |是| M
N --> |否| B
```

**图表来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L900-L970)

### 自动重连机制

当连接失效时，系统会尝试自动重连：

1. **连接状态检查**：定期验证连接有效性
2. **异常捕获**：捕获连接相关的异常
3. **重连策略**：指数退避重连策略
4. **上下文保持**：保持事务上下文

**节来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L930-L970)

### 错误分类与处理

| 错误类型 | 处理策略 | 示例 |
|----------|----------|------|
| 网络超时 | 重试 | `java.net.SocketTimeoutException` |
| 认证失败 | 不重试 | `java.sql.SQLException: Authentication failed` |
| 连接拒绝 | 重试 | `java.net.ConnectException` |
| 查询超时 | 中断查询 | `java.sql.SQLTimeoutException` |

**节来源**
- [driver/util.clj](file://src/metabase/driver/util.clj#L119-L143)

## 性能监控与诊断

### JMX指标收集

系统通过JMX暴露详细的连接池指标：

```mermaid
graph LR
A[C3P0连接池] --> B[JMX MBean]
B --> C[Prometheus收集器]
C --> D[监控仪表板]
subgraph "关键指标"
E[numConnections<br/>当前连接数]
F[numIdleConnections<br/>空闲连接数]
G[numBusyConnections<br/>忙碌连接数]
H[maxPoolSize<br/>最大池大小]
I[numThreadsAwaiting<br/>等待线程数]
end
B --> E
B --> F
B --> G
B --> H
B --> I
```

**图表来源**
- [analytics/prometheus.clj](file://src/metabase/analytics/prometheus.clj#L118-L171)

### 性能指标详解

| 指标名称 | 描述 | 监控意义 |
|----------|------|----------|
| `c3p0_num_connections` | 当前连接总数 | 连接池使用率 |
| `c3p0_num_idle_connections` | 空闲连接数 | 连接复用效率 |
| `c3p0_num_busy_connections` | 忙碌连接数 | 查询并发度 |
| `c3p0_max_pool_size` | 最大池大小 | 配置容量限制 |
| `c3p0_num_threads_awaiting_checkout` | 等待连接的线程数 | 连接竞争情况 |

**节来源**
- [analytics/prometheus.clj](file://src/metabase/analytics/prometheus.clj#L100-L120)

### 查询性能监控

系统记录查询执行的关键性能指标：

```mermaid
sequenceDiagram
participant Query as 查询执行器
participant Monitor as 性能监控器
participant Logger as 日志记录器
participant Metrics as 指标收集器
Query->>Monitor : 开始查询
Monitor->>Monitor : 记录开始时间
Query->>Query : 执行查询
Query->>Monitor : 查询完成
Monitor->>Logger : 记录执行时间
Monitor->>Metrics : 更新性能指标
Metrics-->>Monitor : 指标更新完成
```

**图表来源**
- [sql_jdbc/execute.clj](file://src/metabase/driver/sql_jdbc/execute.clj#L800-L850)

## 连接泄漏检测

### 泄漏检测机制

系统实现了多层次的连接泄漏检测：

```mermaid
flowchart TD
A[连接获取] --> B[记录获取时间]
B --> C[设置超时监控]
C --> D[连接使用中]
D --> E{连接正常归还?}
E --> |是| F[清理监控记录]
E --> |否| G[触发泄漏检测]
G --> H{超时超过阈值?}
H --> |是| I[记录泄漏事件]
H --> |否| J[继续监控]
I --> K[强制关闭连接]
J --> D
K --> L[发送告警通知]
```

**图表来源**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L120-L150)

### 泄漏检测配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `unreturnedConnectionTimeout` | 查询超时 | 连接未返回超时时间 |
| `debugUnreturnedConnectionStackTraces` | false | 是否记录堆栈跟踪 |
| `maxIdleTimeExcessConnections` | 5分钟 | 多余空闲连接清理时间 |

**节来源**
- [driver/settings.clj](file://src/metabase/driver/settings.clj#L120-L150)

### 泄漏告警机制

当检测到连接泄漏时，系统会：

1. **记录详细日志**：包含堆栈跟踪信息
2. **发送告警通知**：通过监控系统告警
3. **强制清理资源**：关闭泄漏的连接
4. **更新统计指标**：记录泄漏次数

**节来源**
- [sql_jdbc/connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L250-L280)

## 最佳实践指南

### 连接池配置建议

#### 生产环境配置

```clojure
;; 应用程序数据库
{:maxPoolSize 15
 :minPoolSize 1
 :maxIdleTime 3600
 :maxConnectionAge 3600
 :idleConnectionTestPeriod 60}

;; 数据仓库数据库  
{:maxPoolSize 50
 :minPoolSize 0
 :maxIdleTime 10800
 :testConnectionOnCheckout true
 :unreturnedConnectionTimeout 1200}
```

#### 开发环境配置

```clojure
;; 减少连接数以节省资源
{:maxPoolSize 5
 :maxIdleTime 1800
 :testConnectionOnCheckout false}
```

### 性能优化建议

1. **合理设置连接池大小**
   - 应用程序数据库：CPU核心数 × 2
   - 数据仓库数据库：CPU核心数 × 4

2. **启用连接验证**
   ```clojure
   {:testConnectionOnCheckout true
    :idleConnectionTestPeriod 60}
   ```

3. **配置适当的超时时间**
   - 连接超时：10秒
   - 查询超时：20分钟（生产环境）

4. **监控连接使用情况**
   - 定期检查连接池利用率
   - 监控连接泄漏事件

### 故障排除指南

#### 常见问题及解决方案

| 问题 | 症状 | 解决方案 |
|------|------|----------|
| 连接池耗尽 | 查询超时，连接等待 | 增加池大小或优化查询 |
| 连接泄漏 | 连接数持续增长 | 启用泄漏检测，检查代码逻辑 |
| SSH隧道失败 | 远程数据库连接失败 | 检查网络和认证配置 |
| 查询超时 | 长时间无响应 | 调整查询超时或优化查询 |

#### 监控检查清单

- [ ] 连接池利用率 < 80%
- [ ] 平均连接获取时间 < 100ms
- [ ] 连接泄漏事件 = 0
- [ ] SSH隧道状态正常
- [ ] 查询执行时间在预期范围内

**节来源**
- [driver/settings.clj](file://src/metabase/driver/settings.clj#L80-L120)
- [app_db/connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj#L80-L150)