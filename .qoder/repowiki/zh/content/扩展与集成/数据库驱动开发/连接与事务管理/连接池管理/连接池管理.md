# 连接池管理

<cite>
**本文档引用的文件**  
- [connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj)
- [connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj)
- [settings.clj](file://src/metabase/driver/settings.clj)
- [prometheus.clj](file://src/metabase/analytics/prometheus.clj)
</cite>

## 目录
1. [连接池配置属性](#连接池配置属性)
2. [连接泄漏检测机制](#连接泄漏检测机制)
3. [连接池生命周期管理](#连接池生命周期管理)
4. [连接池性能调优策略](#连接池性能调优策略)
5. [连接池监控与故障排查](#连接池监控与故障排查)

## 连接池配置属性

Metabase使用c3p0连接池来管理数据仓库数据库的连接。`data-warehouse-connection-pool-properties`多方法定义了连接池的配置属性，这些属性针对数据仓库连接池进行了优化，以最小化内存使用并最大化可靠性。

连接池配置包括以下关键属性：
- **acquireIncrement**: 设置为1，表示一次只获取一个新连接，以最小化内存消耗
- **acquireRetryAttempts**: 在生产环境中设置为0，避免在数据库重启时进行30次重试，从而实现更快的恢复
- **maxIdleTime**: 设置为3小时，表示连接在池中未使用超过3小时后将被丢弃
- **minPoolSize**: 设置为0，对于无服务器数据库，避免定期唤醒以保持连接打开
- **initialPoolSize**: 设置为0，初始连接池大小为0
- **maxPoolSize**: 通过`jdbc-data-warehouse-max-connection-pool-size`设置获取，表示连接池将维护的最大连接数
- **testConnectionOnCheckout**: 设置为true，每次连接检出时都会验证连接的有效性
- **maxIdleTimeExcessConnections**: 设置为5分钟，表示超过minPoolSize的连接在空闲5分钟后将被清除
- **unreturnedConnectionTimeout**: 通过`jdbc-data-warehouse-unreturned-connection-timeout-seconds`设置获取，表示如果连接在指定时间内未被归还，连接池将销毁该连接
- **debugUnreturnedConnectionStackTraces**: 通过`jdbc-data-warehouse-debug-unreturned-connection-stack-traces`设置获取，表示是否捕获未归还连接的堆栈跟踪

**Section sources**
- [connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L50-L154)

## 连接泄漏检测机制

Metabase实现了两种机制来检测和处理连接泄漏：`unreturnedConnectionTimeout`和`debugUnreturnedConnectionStackTraces`。

`unreturnedConnectionTimeout`属性用于设置连接未归还超时时间。如果应用程序检出连接但未在指定时间内归还（即关闭），连接池将直接销毁该连接。这允许偶尔有连接泄漏的应用程序生存下来，而不是最终耗尽连接池。此超时时间应与查询超时时间相同，理论上查询处理器（QP）应在超时后终止查询，但为了安全起见，设置此超时时间是必要的。

`debugUnreturnedConnectionStackTraces`属性用于调试连接泄漏问题。当此属性设置为true且`unreturnedConnectionTimeout`设置为正值时，连接池将捕获所有连接检出的堆栈跟踪，并在未归还的连接超时时打印堆栈跟踪。这有助于调试应用程序中的连接泄漏问题，即应用程序偶尔未能返回连接，导致连接池增长并最终耗尽。需要注意的是，此参数仅应在调试时设置，因为捕获堆栈跟踪会减慢每次连接检出的速度。

**Section sources**
- [connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L128-L154)
- [settings.clj](file://src/metabase/driver/settings.clj#L122-L143)

## 连接池生命周期管理

Metabase通过`create-pool!`、`destroy-pool!`和`database-id->connection-pool`机制来管理连接池的创建、销毁和缓存。

`create-pool!`函数用于为给定数据库创建新的C3P0 `ComboPooledDataSource`。该函数首先获取数据库的连接详情，然后根据这些详情创建连接池。连接池的创建包括处理SSH隧道、认证提供者详情等。

`destroy-pool!`函数用于销毁指定的连接池。该函数首先记录调试信息，然后调用`driver-api/destroy-connection-pool!`来销毁连接池，并关闭相关的SSH隧道。

`database-id->connection-pool`是一个原子映射，用于缓存当前打开的连接池，以数据库ID为键。通过`set-pool!`函数原子地更新连接池，确保在关闭旧池时是线程安全的，并确保每个数据库最多只有一个池打开。`invalidate-pool-for-db!`函数用于使给定数据库的连接池无效，通过关闭它并从缓存中移除。

**Section sources**
- [connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L183-L248)

## 连接池性能调优策略

为了优化连接池性能，Metabase采用了多种策略，包括最小/最大连接数配置、空闲连接超时设置和连接测试策略。

最小连接数（`minPoolSize`）设置为0，这对于无服务器数据库特别重要，因为它避免了定期唤醒数据库以保持连接打开。最大连接数（`maxPoolSize`）通过`jdbc-data-warehouse-max-connection-pool-size`设置控制，默认值为15。如果发现常规使用消耗了所有或接近所有连接，可以考虑增加此值。

空闲连接超时设置包括`maxIdleTime`和`maxIdleTimeExcessConnections`。`maxIdleTime`设置为3小时，表示连接在池中未使用超过3小时后将被丢弃。`maxIdleTimeExcessConnections`设置为5分钟，表示超过最小池大小的连接在空闲5分钟后将被清除，这有助于在负载减少时积极最小化打开的连接数。

连接测试策略包括`testConnectionOnCheckout`和`idleConnectionTestPeriod`。`testConnectionOnCheckout`设置为true，表示每次连接检出时都会验证连接的有效性，这是最简单和最可靠的连接测试形式。对于应用数据库连接池，`idleConnectionTestPeriod`设置为60秒，表示每60秒测试一次空闲的、池化的但未检出的连接。

**Section sources**
- [connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L96-L128)
- [connection_pool_setup.clj](file://src/metabase/app_db/connection_pool_setup.clj#L85-L108)

## 连接池监控与故障排查

Metabase提供了连接池监控和故障排查的实用指南。通过Prometheus集成，可以收集和暴露c3p0连接池的统计信息，包括最大池大小、最小池大小、连接数、空闲连接数、繁忙连接数和等待检出的线程数。

`connection-pool-info`函数构建了当前c3p0连接池的信息映射，通过JMX MBean名称`com.mchange.v2.c3p0:type=PooledDataSource,*`获取所有连接池的诊断信息。这些信息包括`numConnections`、`numIdleConnections`、`numBusyConnections`、`minPoolSize`、`maxPoolSize`和`numThreadsAwaitingCheckoutDefaultUser`等属性。

在故障排查方面，当SSH隧道关闭、数据库详情哈希值更改或密码过期时，连接池将被标记为无效并重新打开。相关的日志消息会记录这些事件，帮助诊断连接问题。例如，当SSH隧道看起来关闭时，会记录红色警告消息；当数据库详情哈希值更改时，会记录黄色警告消息。

**Section sources**
- [prometheus.clj](file://src/metabase/analytics/prometheus.clj#L93-L171)
- [connection.clj](file://src/metabase/driver/sql_jdbc/connection.clj#L245-L273)