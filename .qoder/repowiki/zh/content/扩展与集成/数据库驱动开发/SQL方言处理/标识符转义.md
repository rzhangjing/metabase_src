# 标识符转义

<cite>
**本文档中引用的文件**  
- [sql.clj](file://src/metabase/driver/sql.clj)
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj)
- [quoting.clj](file://src/metabase/driver/sql_jdbc/quoting.clj)
- [honey_sql_2.clj](file://src/metabase/util/honey_sql_2.clj)
- [mysql.clj](file://src/metabase/driver/mysql.clj)
- [postgres.clj](file://src/metabase/driver/postgres.clj)
</cite>

## 目录
1. [引言](#引言)
2. [核心组件分析](#核心组件分析)
3. [标识符标准化处理](#标识符标准化处理)
4. [跨数据库标识符转义策略](#跨数据库标识符转义策略)
5. [复杂标识符处理](#复杂标识符处理)
6. [大小写敏感性处理](#大小写敏感性处理)
7. [Honey SQL集成配置](#honey-sql集成配置)
8. [迁移冲突解决方案](#迁移冲突解决方案)

## 引言
本文档深入分析Metabase系统中标识符转义的实现机制，重点研究SQL驱动中的quote-name-parts多态方法。文档将详细解释normalize命名空间如何为不同数据库（如MySQL、PostgreSQL、SQL Server）标准化标识符处理规则，涵盖复杂标识符的转义策略和大小写敏感性处理。

## 核心组件分析

**Section sources**
- [sql.clj](file://src/metabase/driver/sql.clj#L1-L326)
- [honey_sql_2.clj](file://src/metabase/util/honey_sql_2.clj#L1-L519)

## 标识符标准化处理

```mermaid
classDiagram
class normalize-unquoted-name {
+normalize-unquoted-name(driver, name-str)
+normalize-name(driver, name-str)
+reserved-literal(driver, name)
}
class quote-style {
+quote-style(driver)
+with-quoting(driver, body)
}
normalize-unquoted-name --> quote-style : "uses"
```

**Diagram sources**
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj#L1-L52)
- [sql.clj](file://src/metabase/driver/sql.clj#L468-L495)

**Section sources**
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj#L1-L52)

## 跨数据库标识符转义策略

```mermaid
sequenceDiagram
participant Driver as "数据库驱动"
participant Normalizer as "标识符标准化器"
participant Quoter as "引用处理器"
participant SQL as "SQL生成器"
Driver->>Normalizer : normalize-name(driver, name-str)
Normalizer->>Normalizer : 检查引号风格
Normalizer->>Normalizer : 处理已引用的标识符
Normalizer->>Normalizer : 标准化未引用的标识符
Normalizer-->>Driver : 返回标准化名称
Driver->>Quoter : quote-name(driver, type, components)
Quoter->>SQL : format-honeysql(driver, identifier)
SQL-->>Driver : 返回转义后的SQL
```

**Diagram sources**
- [sql.clj](file://src/metabase/driver/sql.clj#L28-L54)
- [quoting.clj](file://src/metabase/driver/sql_jdbc/quoting.clj#L1-L27)

**Section sources**
- [sql.clj](file://src/metabase/driver/sql.clj#L28-L54)
- [quoting.clj](file://src/metabase/driver/sql_jdbc/quoting.clj#L1-L27)

## 复杂标识符处理

```mermaid
flowchart TD
Start([开始]) --> CheckQuote["检查标识符是否已引用"]
CheckQuote --> |是| ProcessQuoted["处理已引用的标识符"]
CheckQuote --> |否| Normalize["标准化未引用的标识符"]
ProcessQuoted --> Extract["提取引号内的内容"]
Extract --> HandleEscape["处理转义字符"]
HandleEscape --> ReturnResult["返回处理结果"]
Normalize --> LowerCase["转换为小写"]
LowerCase --> CheckReserved["检查是否为保留字"]
CheckReserved --> |是| HandleReserved["特殊处理保留字"]
CheckReserved --> |否| ReturnResult
HandleReserved --> ReturnResult
```

**Diagram sources**
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj#L1-L52)
- [honey_sql_2.clj](file://src/metabase/util/honey_sql_2.clj#L97-L142)

**Section sources**
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj#L1-L52)

## 大小写敏感性处理

```mermaid
classDiagram
class Identifier {
+identifier(identifier-type, components)
+identifier->components(identifier)
+identifier?
+IdentifierType
}
class format-identifier {
+format-identifier(tag, args)
}
class quote-style {
+quote-style(driver)
}
Identifier --> format-identifier : "uses"
format-identifier --> quote-style : "depends on"
```

**Diagram sources**
- [honey_sql_2.clj](file://src/metabase/util/honey_sql_2.clj#L97-L172)
- [sql.clj](file://src/metabase/driver/sql.clj#L502)

**Section sources**
- [honey_sql_2.clj](file://src/metabase/util/honey_sql_2.clj#L97-L172)

## Honey SQL集成配置

```mermaid
sequenceDiagram
participant User as "用户"
participant Driver as "数据库驱动"
participant HoneySQL as "Honey SQL"
participant Dialect as "方言处理器"
User->>Driver : 配置引用策略
Driver->>HoneySQL : 设置方言
HoneySQL->>Dialect : 注册方言
Dialect->>Dialect : 定义引用字符
Dialect-->>HoneySQL : 返回方言配置
HoneySQL-->>Driver : 准备SQL生成
Driver-->>User : 完成配置
```

**Diagram sources**
- [mysql.clj](file://src/metabase/driver/mysql.clj#L703)
- [postgres.clj](file://src/metabase/driver/postgres.clj#L1-L200)

**Section sources**
- [mysql.clj](file://src/metabase/driver/mysql.clj#L703)
- [postgres.clj](file://src/metabase/driver/postgres.clj#L1-L200)

## 迁移冲突解决方案

```mermaid
flowchart LR
A[源数据库] --> B{标识符检查}
B --> C[处理特殊字符]
B --> D[处理大小写]
B --> E[处理保留字]
C --> F[应用目标数据库规则]
D --> F
E --> F
F --> G[生成兼容SQL]
G --> H[目标数据库]
```

**Diagram sources**
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj#L1-L52)
- [sql.clj](file://src/metabase/driver/sql.clj#L1-L326)

**Section sources**
- [normalize.clj](file://src/metabase/driver/sql/normalize.clj#L1-L52)